# ShiftWithアプリ 単体テスト仕様書

## 1. テスト概要

ShiftWithアプリの主要機能に対する単体テストを実装しました。テストはJestとReact Testing Libraryを使用して作成されており、特に以下の領域に焦点を当てています：

1. **認証機能テスト** - ユーザー認証関連の機能テスト
2. **ギバースコア計算ロジックテスト** - ユーザーの活動に基づくスコア計算の検証
3. **パーソナリティ判定テスト** - ユーザータイプの判定ロジックの検証
4. **教材関連機能テスト** - 教材の取得・表示機能の検証
5. **フィードバックシステムテスト** - フィードバック提供・取得機能の検証
6. **ユーザー活動追跡テスト** - ユーザーの行動記録機能の検証
7. **バッジ評価ロジックテスト** - バッジ獲得条件の評価ロジックの検証

## 2. テストファイル構成

テストファイルは対応するソースファイルと同じディレクトリに配置され、`.test.ts`または`.test.tsx`の拡張子を持ちます。

```
src/
├── lib/
│   ├── __tests__/
│   │   └── auth.test.ts        # 認証機能テスト
│   │
├── hooks/
│   ├── __tests__/
│   │   └── useAuth.test.tsx    # 認証フックテスト
│   │
├── utils/
│   ├── __tests__/
│   │   ├── score.test.ts           # スコア計算テスト
│   │   ├── personality.test.ts     # パーソナリティ判定テスト
│   │   ├── quiz.test.ts            # クイズロジックテスト
│   │   ├── feedback.test.ts        # フィードバック機能テスト
│   │   ├── UserActivityTracker.test.ts  # ユーザー活動追跡テスト
│   │   └── badgeEvaluator.test.ts  # バッジ評価テスト
│   │
├── lib/api/
│   ├── __tests__/
│   │   └── materials.test.ts   # 教材API機能テスト
│   │
└── models/
    ├── __tests__/
        └── MaterialModel.test.ts  # 教材モデルテスト
```

## 3. テスト実行方法

### 全テスト実行

```bash
npm test
```

### 特定のテスト実行

```bash
npm test -- src/utils/__tests__/score.test.ts
```

### ウォッチモードでのテスト実行（変更を監視）

```bash
npm run test:watch
```

### テストカバレッジレポートの生成

```bash
npm test -- --coverage
```

カバレッジレポートは`coverage/`ディレクトリに生成されます。

## 4. テスト対象機能と検証ポイント

### 4.1 認証機能テスト

**テストファイル**: `src/lib/__tests__/auth.test.ts`、`src/hooks/__tests__/useAuth.test.tsx`

**検証ポイント**:
- セッション情報の取得と解析の正確性
- 権限チェック機能の動作
- ログイン・ログアウト処理の正確性
- エラーハンドリングの適切さ

### 4.2 ギバースコア計算ロジックテスト

**テストファイル**: `src/utils/__tests__/score.test.ts`

**検証ポイント**:
- 活動タイプによる影響度の計算
- 時間経過による減衰効果
- 条件付きポイント計算
- 境界条件での挙動

### 4.3 パーソナリティ判定テスト

**テストファイル**: `src/utils/__tests__/personality.test.ts`

**検証ポイント**:
- スコアからのパーソナリティタイプ判定
- タイプ判定の閾値
- 多数のスコアパターンでの挙動

### 4.4 教材関連機能テスト

**テストファイル**: `src/lib/api/__tests__/materials.test.ts`、`src/models/__tests__/MaterialModel.test.ts`

**検証ポイント**:
- 教材データの取得と形式
- 教材バリデーションロジック
- フィルタリングとソート機能
- エラーハンドリング

### 4.5 フィードバックシステムテスト

**テストファイル**: `src/utils/__tests__/feedback.test.ts`

**検証ポイント**:
- フィードバック送信・保存機能
- 教材別フィードバック表示
- ユーザー別フィードバック履歴
- 統計情報の計算精度

### 4.6 ユーザー活動追跡テスト

**テストファイル**: `src/utils/__tests__/UserActivityTracker.test.ts`

**検証ポイント**:
- アクティビティ記録の正確性
- 履歴取得機能
- 集計カウント計算
- 日付範囲指定の機能

### 4.7 バッジ評価ロジックテスト

**テストファイル**: `src/utils/__tests__/badgeEvaluator.test.ts`

**検証ポイント**:
- バッジ獲得条件の評価
- 複合条件判定
- メタデータを含む複雑な条件
- 特殊条件（連続ストリークなど）

## 5. モック戦略

テストでは以下のモックアプローチを採用しています：

1. **外部依存性のモック**: Supabaseなどの外部APIはすべてモック化
2. **日付/時間のモック**: `jest.useFakeTimers()`を使用して時間依存のテストを安定化
3. **環境変数のモック**: テスト用の環境変数を`setupTests.ts`で設定
4. **ブラウザAPIのモック**: `IntersectionObserver`や`MutationObserver`などのブラウザAPIをモック化

## 6. テストカバレッジ目標

- 全体: 80%以上
- 重要ロジック（ギバースコア計算、認証、バッジ評価）: 90%以上

## 7. 今後の改善点

1. UIコンポーネントのテスト強化
2. エンドツーエンドテストとの連携改善
3. スナップショットテストの追加
4. ユーザーイベントを含む複合テストシナリオの追加 