# セキュリティ設計

## 関連ドキュメント
- [データベース詳細設計](../01_プロジェクト概要/05_データベース詳細設計.md)
- [APIインターフェース仕様書](./04_APIインターフェース仕様書.md)
- [コンポーネント詳細設計](../01_プロジェクト概要/06_コンポーネント詳細設計.md)
- [デプロイメント構成図](./06_デプロイメント構成図.md)
- [UI/UXデザイン仕様書](../01_プロジェクト概要/07_UI_UXデザイン仕様書.md)

## 概要
本ドキュメントはShiftWithアプリケーションのセキュリティ設計について記述します。認証・認可、データ保護、エンドポイントセキュリティなど、アプリケーション全体のセキュリティ対策について説明します。

## 認証システム

### 認証方式
ShiftWithアプリケーションはSupabase Authを使用した認証システムを採用しています。

#### 主な認証方法
1. **メール/パスワード認証**
   - セキュアなパスワードポリシーの適用
   - パスワードハッシュ化（Argon2id）
   - レート制限による総当たり攻撃対策

2. **ソーシャル認証（オプション）**
   - Google認証
   - GitHub認証
   - Microsoftアカウント認証

3. **メールマジックリンク**
   - パスワードレス認証オプション
   - 一時的な認証リンクをメールで送信

#### セッション管理
- JWTベースのセッション管理
- アクセストークン有効期限: 1時間
- リフレッシュトークン有効期限: 7日間
- セキュアなCookie設定 (HttpOnly, SameSite=Strict)

### 多要素認証 (MFA)
将来のフェーズで実装予定:
- SMSまたはメールによるワンタイムパスワード
- 認証アプリ（Google Authenticatorなど）との連携
- WebAuthn/FIDO2による生体認証

## 認可システム

### ロールベースアクセス制御 (RBAC)
以下のユーザーロールを定義:

| ロール | 説明 | 主な権限 |
|------|------|--------|
| 一般ユーザー | 標準的なアプリケーションユーザー | コンテンツ閲覧、教材作成、コメント投稿 |
| モデレーター | コンテンツ監視者 | 上記 + コメント・教材の承認/拒否 |
| 管理者 | システム管理者 | 上記 + ユーザー管理、システム設定 |

### Row Level Security (RLS)
Supabaseのデータベースに対して以下のRLSポリシーを適用:

#### 例: materialsテーブルのRLSポリシー
```sql
-- 公開済み教材は誰でも閲覧可能
CREATE POLICY "公開済み教材の閲覧" ON materials
FOR SELECT
USING (status = 'published');

-- 下書き教材は作成者のみ閲覧可能
CREATE POLICY "下書き教材の閲覧" ON materials
FOR SELECT
USING (status = 'draft' AND auth.uid() = author_id);

-- 教材の編集・削除は作成者のみ可能
CREATE POLICY "教材の編集" ON materials
FOR UPDATE
USING (auth.uid() = author_id);

CREATE POLICY "教材の削除" ON materials
FOR DELETE
USING (auth.uid() = author_id);

-- 教材の作成時は作成者IDを自動設定
CREATE POLICY "教材の作成" ON materials
FOR INSERT
WITH CHECK (author_id = auth.uid());
```

#### 例: profilesテーブルのRLSポリシー
```sql
-- プロフィールは誰でも閲覧可能
CREATE POLICY "プロフィール閲覧" ON profiles
FOR SELECT
USING (true);

-- プロフィール編集は本人のみ可能
CREATE POLICY "プロフィール編集" ON profiles
FOR UPDATE
USING (auth.uid() = id);
```

### API認可
APIエンドポイントは以下の保護メカニズムを実装:

1. JWTトークン検証
2. クレームベースの権限チェック
3. リソースオーナーシップ検証

## データ保護

### 保管データの暗号化

#### データベース暗号化
- Supabase PostgreSQLの透過的データ暗号化 (TDE)
- センシティブフィールドの列レベル暗号化
- バックアップの暗号化

#### 暗号化アルゴリズム
- AES-256-GCM: センシティブなデータの暗号化
- PBKDF2: パスワードベース鍵導出関数

### 転送中データの保護
- TLS 1.3を使用したすべてのHTTP通信の暗号化
- 強力な暗号スイートの使用
- HTTPSの強制（HSTS実装）
- 安全なWebSocketコネクション

### バックアップと災害復旧
- 日次自動バックアップ
- 暗号化されたバックアップストレージ
- 30日間のバックアップ保持ポリシー
- ポイントインタイムリカバリ機能

## エンドポイントセキュリティ

### APIセキュリティ
- 入力バリデーション
- パラメータサニタイズ
- ネストされたオブジェクトの深度制限
- レスポンスの内容制限（情報漏洩防止）

### レート制限
以下のエンドポイントにレート制限を適用:

| エンドポイント | 期間 | 制限回数 | 対象 |
|--------------|------|--------|------|
| 認証エンドポイント | 1分 | 10回 | IPアドレス |
| APIエンドポイント | 1分 | 60回 | ユーザーID |
| ファイルアップロード | 1時間 | 50回 | ユーザーID |

### CSRFトークン検証
- すべてのPOST/PUT/DELETE処理でCSRFトークン検証
- Double Submit Cookie Pattern
- トークンの定期的なローテーション

## フロントエンドセキュリティ

### Content Security Policy (CSP)
以下のCSP設定を実装:

```
Content-Security-Policy: 
  default-src 'self';
  script-src 'self' https://analytics.example.com;
  style-src 'self' https://fonts.googleapis.com;
  img-src 'self' https://storage.googleapis.com data:;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://api.example.com wss://realtime.example.com;
  frame-ancestors 'none';
  form-action 'self';
```

### 安全な依存関係管理
- 定期的な依存パッケージの脆弱性スキャン
- npm/yarn監査の自動化
- SBOMの生成と管理
- 依存関係の定期的な更新

### クライアントサイドストレージのセキュリティ
- センシティブデータのローカルストレージ回避
- JWTはメモリまたはhttpOnlyクッキーのみに保存
- セッションストレージの適切な使用
- ブラウザキャッシュ制御

## インフラストラクチャセキュリティ

### クラウドサービスセキュリティ
- Supabase環境のセキュア構成
- 最小権限の原則に基づくIAMポリシー
- サブネットとVPCの適切な構成
- セキュリティグループとファイアウォールルールの適用

### コンテナセキュリティ
- イメージ脆弱性スキャン
- 最小特権コンテナ実行
- イメージ署名と検証
- シークレット管理

### CI/CDパイプラインセキュリティ
- ソースコードの静的解析（SAST）
- 依存関係脆弱性スキャン
- インフラストラクチャアズコードの脆弱性検査
- デプロイ前の自動セキュリティテスト

## モニタリングと監査

### セキュリティロギング
- ユーザーアクションの監査ログ
- 認証イベントの記録
- 管理操作の詳細ログ
- セキュリティイベントの集中ログ管理

### インシデント検出・対応
- 異常アクセスパターンの検出
- ブルートフォース攻撃の検知
- 不正アクセス検知
- インシデント対応プロセスの確立

### 定期的なセキュリティレビュー
- 四半期ごとのセキュリティ設定レビュー
- 年次ペネトレーションテスト
- ソースコードセキュリティレビュー
- セキュリティポリシーの更新

## コンプライアンス対応

### データプライバシー対応
- GDPR対応機能
  - データエクスポート機能
  - 忘れられる権利（データ削除）
  - 同意管理
- プライバシーポリシーの明示

### セキュリティコンプライアンス
- OWASP Top 10対策の実装
- セキュリティベストプラクティスの適用
- インシデントレポート体制の確立

## セキュリティテスト

### 自動化セキュリティテスト
- 静的アプリケーションセキュリティテスト (SAST)
- 動的アプリケーションセキュリティテスト (DAST)
- 依存関係脆弱性スキャン
- APIセキュリティテスト

### 手動セキュリティテスト
- コードレビュー
- ペネトレーションテスト
- 脆弱性評価
- セキュリティアーキテクチャレビュー

## 開発者セキュリティガイドライン

### セキュアコーディングプラクティス
- 入力検証の徹底
- パラメータ化SQLクエリの使用
- XSS対策の実装
- 適切なエラーハンドリング

### シークレット管理
- 環境変数の適切な使用
- APIキーのローテーション
- シークレットの安全な保存
- 本番環境と開発環境の分離

### リソースの安全な共有
- 認証を必要とするファイル共有
- コンテンツのアクセス制御
- 一時的なURL生成とアクセス制限
- ファイルタイプの制限と検証

## セキュリティロードマップ

### 短期計画（3ヶ月）
- 基本認証・認可システムの実装
- RLSポリシーの完全実装
- セキュリティログの設定
- CIパイプラインへのセキュリティスキャン追加

### 中期計画（6ヶ月）
- 多要素認証(MFA)の実装
- セキュリティモニタリングの強化
- 自動セキュリティテストの拡充
- プライバシー設定の強化

### 長期計画（12ヶ月）
- セキュリティ監査の完全実施
- 高度な脅威検知システムの導入
- セキュリティ認証の取得
- リアルタイム脆弱性モニタリング 