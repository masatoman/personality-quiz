# 🚨 緊急時対応チェックリスト

## 🎯 **概要**
本番環境で問題が発生した際の迅速な対応手順とチェック項目をまとめます。

## 🚨 **重大度レベル**

### 🔴 **レベル1: サービス完全停止**
- 全ページアクセス不可
- API完全応答なし
- ユーザー完全ログイン不可

### 🟡 **レベル2: 機能一部停止**
- 特定機能のみ動作不良
- API一部エラー
- パフォーマンス大幅劣化

### 🟢 **レベル3: 軽微な問題**
- UI表示崩れ
- 非重要機能の問題
- パフォーマンス軽微劣化

## 🔴 **レベル1対応: サービス完全停止**

### ⏱️ **即座対応（5分以内）**

#### 1. 状況確認
```bash
# 基本接続確認
curl -I https://shiftwith-sigma.vercel.app/

# DNS確認
nslookup shiftwith-sigma.vercel.app

# Vercel状態確認
npm run deploy:status:production
```

#### 2. 緊急ロールバック
```bash
# 即座にロールバック実行
npm run deploy:rollback:production

# ロールバック確認
sleep 30
curl -I https://shiftwith-sigma.vercel.app/
```

#### 3. 通知・連絡
- [ ] チームSlackに緊急報告
- [ ] ステークホルダーに状況報告
- [ ] 必要に応じて外部告知

### 🔍 **詳細調査（10分以内）**

#### 1. ログ確認
```bash
# Vercelログ確認
npm run deploy:logs:production

# エラーパターン確認
vercel logs production --limit 200 | grep -i error
```

#### 2. 監視ツール確認
- [ ] Vercel Analytics確認
- [ ] Supabase監視ダッシュボード
- [ ] 外部監視サービス（UptimeRobot等）

#### 3. 原因特定
- [ ] 最新デプロイとの関連確認
- [ ] 外部サービス障害確認
- [ ] ネットワーク問題確認

### 🛠️ **修復作業（30分以内）**

#### パターンA: コード問題
```bash
# ホットフィックス作成
git checkout main
git checkout -b hotfix/emergency-fix

# 問題修正
# コード修正作業

# 緊急デプロイ
git commit -m "hotfix: 緊急修正"
git push origin hotfix/emergency-fix
npm run deploy:production
```

#### パターンB: 設定問題
```bash
# 環境変数確認・修正
vercel env list production
vercel env add VARIABLE_NAME value production

# 強制再デプロイ
vercel --prod --force
```

#### パターンC: 外部サービス問題
- Supabase障害確認・対応
- CDN問題確認・対応
- DNS問題確認・対応

## 🟡 **レベル2対応: 機能一部停止**

### ⏱️ **確認・分析（15分以内）**

#### 1. 影響範囲特定
```bash
# 各API確認
curl -s https://shiftwith-sigma.vercel.app/api/profiles
curl -s https://shiftwith-sigma.vercel.app/api/materials
curl -s https://shiftwith-sigma.vercel.app/api/dashboard

# 特定ページ確認
curl -I https://shiftwith-sigma.vercel.app/dashboard
curl -I https://shiftwith-sigma.vercel.app/materials
```

#### 2. エラーログ分析
```bash
# 特定エラーパターン検索
npm run deploy:logs:production | grep -A5 -B5 "ERROR"

# API別エラー確認
npm run deploy:logs:production | grep "api/"
```

### 🔧 **対応判断**

#### 即座ロールバックの場合
- ユーザー影響が深刻
- 修正時間が長期化予想
- 次善策が不明

#### 段階的修正の場合
- 影響範囲が限定的
- 短時間で修正可能
- 明確な解決策がある

### 🛠️ **修正・デプロイ**

```bash
# 修正作業
git checkout -b fix/issue-name

# テスト・確認
npm run test
npm run build

# ステージング確認
npm run deploy:staging
sleep 30
curl -I https://staging.shiftwith.app/

# 本番デプロイ
npm run deploy:production
```

## 🟢 **レベル3対応: 軽微な問題**

### 📋 **記録・スケジューリング**
- [ ] 問題内容を詳細記録
- [ ] 再現手順を確認
- [ ] 次回定期メンテナンスで修正
- [ ] 必要に応じてワークアラウンド提供

## 📞 **連絡先・情報**

### 🚨 **緊急連絡先**
```
開発チーム: #shiftwith-dev
インフラ管理: #shiftwith-ops
ステークホルダー: #shiftwith-business
```

### 🔗 **重要リンク**
- Vercel Dashboard: https://vercel.com/dashboard
- Supabase Dashboard: https://supabase.com/dashboard
- GitHub Repository: https://github.com/your-org/shiftwith
- 監視ダッシュボード: [監視ツールURL]

### 📋 **アクセス情報**
```bash
# Vercel CLI認証
vercel login

# 重要な環境変数
echo $VERCEL_TOKEN
echo $SUPABASE_SERVICE_ROLE_KEY
```

## 📊 **事後対応**

### 📝 **インシデントレポート作成**
```markdown
## インシデントレポート

**発生日時**: YYYY-MM-DD HH:MM JST
**重大度**: レベル1/2/3
**影響範囲**: [詳細記載]
**原因**: [根本原因]
**対応時間**: [検知から復旧まで]

### タイムライン
- HH:MM 問題検知
- HH:MM 対応開始
- HH:MM 復旧完了

### 根本原因
[詳細な原因分析]

### 対応策
[実施した対応]

### 再発防止策
[今後の改善計画]
```

### 🔄 **改善計画**
- [ ] 根本原因の恒久対策
- [ ] 監視強化
- [ ] 自動化改善
- [ ] チーム教育・訓練

## 🎯 **予防策**

### 🔍 **監視強化**
```bash
# 定期ヘルスチェック
*/5 * * * * curl -I https://shiftwith-sigma.vercel.app/

# アラート設定
- エラー率 > 5%
- レスポンス時間 > 5s
- 稼働率 < 99%
```

### 🧪 **テスト強化**
- E2Eテストの充実
- ロードテストの実施
- 災害復旧テスト

### 📚 **ドキュメント整備**
- 運用手順書の更新
- 緊急連絡先の整備
- チーム教育資料の作成

## 🎭 **障害訓練**

### 📅 **定期訓練計画**
- **月次**: 軽微障害対応訓練
- **四半期**: 重大障害対応訓練
- **年次**: 総合災害復旧訓練

### 🎯 **訓練項目**
- [ ] 障害検知から5分以内の初動対応
- [ ] ロールバック手順の実行
- [ ] チーム内連絡・報告
- [ ] ステークホルダーとの連携

---

## 📞 **緊急時クイックリファレンス**

### 🚨 **最重要コマンド**
```bash
# 本番環境状態確認
curl -I https://shiftwith-sigma.vercel.app/

# 即座ロールバック
npm run deploy:rollback:production

# ログ確認
npm run deploy:logs:production

# 緊急デプロイ
npm run deploy:production
```

### ⏱️ **対応時間目標**
- **検知**: 5分以内
- **初動対応**: 10分以内
- **復旧**: 30分以内
- **根本対策**: 24時間以内

---

**🚨 緊急時は冷静に、このチェックリストに従って対応しましょう！**
