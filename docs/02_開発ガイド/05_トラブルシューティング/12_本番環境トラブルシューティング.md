# 🚨 本番環境トラブルシューティング

## 📋 **現在の状況**
- **本番URL**: https://shiftwith-sigma.vercel.app/
- **問題**: 教材一覧で「教材の取得に失敗しました」エラー
- **API**: `/api/materials` で `{"error":"教材の取得に失敗しました"}`
- **フロントエンド**: 「教材を読み込み中...」→「エラーが発生しました」

## 🔍 **問題特定手順**

### 1. Vercel環境変数確認（最優先）

#### Vercelダッシュボードでの確認手順
1. [Vercelダッシュボード](https://vercel.com/dashboard) → プロジェクト選択
2. **Settings** → **Environment Variables**
3. 以下の環境変数が正しく設定されているか確認：

```bash
# 必須環境変数
NEXT_PUBLIC_SUPABASE_URL=https://btakhtivpdhieruediwt.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0YWtodGl2cGRoaWVydWVkaXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNjgwNTEsImV4cCI6MjA1OTg0NDA1MX0.lWbw-E5SZ0gVmXhr2Q5iVp3Xohz-maRuPhLi7YSSxOo

# オプション（RLSポリシー用）
SUPABASE_SERVICE_ROLE_KEY=[SERVICE_ROLE_KEY]
```

#### 環境変数設定手順
1. **Add** ボタンクリック
2. **Name**: `NEXT_PUBLIC_SUPABASE_URL`
3. **Value**: `https://btakhtivpdhieruediwt.supabase.co`
4. **Environment**: **Production** ✅ チェック
5. **Save** クリック

同様に `NEXT_PUBLIC_SUPABASE_ANON_KEY` も設定

### 2. 強制再デプロイ実行

環境変数設定後、強制再デプロイを実行：

#### Vercelダッシュボードから
1. **Deployments** タブ
2. 最新デプロイメントの **...** → **Redeploy**
3. **Use existing Build Cache** ❌ チェック外す
4. **Redeploy** クリック

#### Vercel CLIから
```bash
vercel --prod --force
```

### 3. デプロイ後の確認テスト

#### A. 基本接続確認
```bash
# HTTP Status確認
curl -I https://shiftwith-sigma.vercel.app/

# 期待値: HTTP/2 200 OK
```

#### B. API動作確認
```bash
# Materials API確認
curl https://shiftwith-sigma.vercel.app/api/materials

# 期待値: JSON形式で教材データ
```

#### C. 本番環境でのSupabase接続テスト
```bash
# Supabase直接テスト
curl -X GET "https://btakhtivpdhieruediwt.supabase.co/rest/v1/materials?select=id,title&limit=1" \
  -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 期待値: 教材データのJSON
```

### 4. RLSポリシー確認（Supabase側）

#### Supabaseダッシュボードで確認
1. [Supabase Dashboard](https://app.supabase.com/projects) → プロジェクト選択
2. **Authentication** → **Policies**
3. `materials` テーブルのポリシー確認：

```sql
-- 現在のポリシー確認
SELECT schemaname, tablename, policyname, cmd, qual 
FROM pg_policies 
WHERE tablename = 'materials';

-- 期待値: is_published = true の読み取りポリシー存在
```

#### ポリシー修正（必要な場合）
```sql
-- 不正なポリシー削除
DROP POLICY IF EXISTS "Enable read for published materials" ON materials;

-- 正しいポリシー追加
CREATE POLICY "Enable read for published materials" ON materials
FOR SELECT USING (is_published = true);
```

### 5. 段階的デバッグ

#### A. APIレベルでのデバッグ
```javascript
// src/app/api/materials/route.ts にログ追加
console.log('Environment:', {
  url: process.env.NEXT_PUBLIC_SUPABASE_URL,
  keyExists: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
});
```

#### B. フロントエンドでのデバッグ
```javascript
// MaterialsList.tsx にログ追加
console.log('API Response:', response);
console.log('API Error:', error);
```

## 🎯 **解決パターン別対応**

### パターン1: 環境変数未設定
- **現象**: API全体が500エラー
- **対応**: Vercel環境変数設定 + 再デプロイ
- **確認**: `/api/materials` で正常レスポンス

### パターン2: RLSポリシー問題  
- **現象**: 401 Unauthorized or 空配列
- **対応**: Supabaseポリシー修正
- **確認**: Supabase直接クエリで正常レスポンス

### パターン3: ネットワーク問題
- **現象**: Timeout エラー
- **対応**: Vercel リージョン確認・CDN確認
- **確認**: 複数地域からのアクセステスト

### パターン4: キャッシュ問題
- **現象**: 古いエラー表示継続
- **対応**: 強制再デプロイ・キャッシュクリア
- **確認**: `Ctrl+F5` ハードリフレッシュで正常表示

## 📞 **エスカレーション基準**

### 即座にエスカレーション
- Supabase全体ダウン
- Vercel全体ダウン  
- セキュリティインシデント

### 30分後にエスカレーション
- 環境変数設定後も改善なし
- RLSポリシー修正後も改善なし
- 複数地域からアクセス不可

### 1時間後にエスカレーション
- 全手順実施後も改善なし
- 原因不明のエラー継続
- ユーザー影響拡大

## 📈 **予防策**

### 監視設定
- Vercel Analytics での死活監視
- Supabase Health Check設定
- 重要API のUptime監視

### デプロイ前チェック
- 環境変数設定確認
- RLSポリシーテスト
- ステージング環境での動作確認

### ロールバック準備
- 安定版コミットハッシュ記録
- 5分以内ロールバック手順
- 緊急連絡体制整備 

# 🚨 Supabase認証設定の本番環境保護

## 🔒 **Site URL設定**

### 本番環境（Recommended）
```
Site URL: https://shiftwith-sigma.vercel.app
```

### 開発環境（別プロジェクト推奨）
```
Site URL: http://localhost:3000
```

## 🛡️ **Redirect URLs設定**

### ❌ **現在の問題設定**
```
❌ http://localhost:3000/auth/callback  // 本番環境から削除必須
✅ https://shiftwith-sigma.vercel.app/   // 本番用はこれのみ
```

### ✅ **本番環境の推奨設定**
```
Redirect URLs:
- https://shiftwith-sigma.vercel.app/
- https://shiftwith-sigma.vercel.app/auth/callback
- https://shiftwith-sigma.vercel.app/welcome
```

### 🧪 **開発環境の設定（別プロジェクト）**
```
Redirect URLs:
- http://localhost:3000/auth/callback
- http://localhost:3000/welcome
- http://localhost:3000/
```

## 🔧 **緊急修正手順**

### 1. 本番Supabaseプロジェクトの設定修正
```bash
# Supabase Dashboard > Authentication > URL Configuration
1. Site URL: https://shiftwith-sigma.vercel.app （確認済み）
2. Redirect URLs: 
   - http://localhost:3000/auth/callback を削除
   - https://shiftwith-sigma.vercel.app/auth/callback を追加（必要に応じて）
```

### 2. 環境分離の推奨構成
```
本番環境: shiftwith-sigma-production
開発環境: shiftwith-sigma-development
```

## 📋 **修正チェックリスト**

### ⚡ **緊急対応（今すぐ実行）**
- [ ] Supabase Dashboard > Authentication > URL Configuration
- [ ] `http://localhost:3000/auth/callback` を削除
- [ ] 本番環境のログイン・ログアウトテスト実行
- [ ] 開発環境での認証テスト実行（失敗することを確認）

### 🔄 **推奨追加設定**
- [ ] `https://shiftwith-sigma.vercel.app/auth/callback` 追加
- [ ] `https://shiftwith-sigma.vercel.app/welcome` 追加
- [ ] 認証フローの全パターンテスト

### 🛡️ **セキュリティ強化**
- [ ] 本番・開発環境の完全分離検討
- [ ] IP制限の設定検討
- [ ] 認証ログの監視設定

## 🧪 **修正後テスト手順**

### 1. 本番環境テスト（playwright-mcp使用）
```javascript
// ログインフローテスト
mcp_playwright-mcp_browser_navigate({ url: "https://shiftwith-sigma.vercel.app/auth/login" })
mcp_playwright-mcp_browser_snapshot()
mcp_playwright-mcp_browser_type({ element: "メールアドレス", ref: "input[name='email']", text: "test@example.com" })
mcp_playwright-mcp_browser_type({ element: "パスワード", ref: "input[name='password']", text: "testpassword" })
mcp_playwright-mcp_browser_click({ element: "ログインボタン", ref: "button[type='submit']" })
```

### 2. 開発環境での影響確認
```javascript
// 開発環境認証の失敗確認
mcp_playwright-mcp_browser_navigate({ url: "http://localhost:3000/auth/login" })
// 認証エラーが発生することを確認
```

### 3. 動作確認項目
- [ ] 本番ログイン成功
- [ ] 本番ログアウト成功  
- [ ] 本番新規登録成功
- [ ] 開発環境認証失敗（期待動作）
- [ ] リダイレクト先の正常性

## 🚑 **トラブル発生時の対応**

### 認証エラーが発生した場合
1. **即座にロールバック**: 修正前の設定に戻す
2. **影響範囲調査**: ユーザーからの報告確認
3. **段階的修正**: 1つずつ設定を追加してテスト

### 完全復旧手順
```bash
# 1. 設定確認
curl -X GET "https://shiftwith-sigma.vercel.app/api/auth/test"

# 2. Supabase設定の段階的修正
# 3. 各段階でのテスト実行
# 4. 正常動作確認後に次の設定適用
``` 