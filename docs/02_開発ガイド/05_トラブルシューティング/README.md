# 🚨 トラブルシューティング

## 📋 **概要**
ShiftWithプロジェクトで発生する問題の迅速な解決、緊急事態対応、システム復旧のためのドキュメント集です。

## 📚 **ドキュメント一覧**

### 🚨 **緊急対応 (最優先)**

#### [⚡ 緊急時対応チェックリスト](./16_緊急時対応チェックリスト.md) ⭐
- **5分以内の初動対応手順**
- 重大度別対応フロー
- 即座ロールバック手順
- 緊急連絡体制

### 🔧 **問題解決・復旧**

#### [🛠️ 本番環境トラブルシューティング](./12_本番環境トラブルシューティング.md)
- 本番環境特有の問題対応
- システム復旧手順
- ログ分析方法
- パフォーマンス問題対応

#### [🔄 緊急環境分離計画](./13_緊急環境分離計画.md)
- 環境間の問題波及防止
- 緊急時の環境分離手順
- データベース切り替え
- 障害拡大防止策

## 🚨 **緊急度別対応ガイド**

### 🔴 **レベル1: サービス完全停止 (5分以内対応)**
```bash
# 即座確認
curl -I https://shiftwith-sigma.vercel.app/

# 緊急ロールバック
npm run deploy:rollback:production

# 状況報告
# チームSlackへ緊急報告
```

**対象問題:**
- 全ページアクセス不可
- API完全応答なし
- データベース接続不可

### 🟡 **レベル2: 機能一部停止 (15分以内対応)**
```bash
# 影響範囲確認
npm run check:production
npm run deploy:logs:production

# 段階的修正またはロールバック判断
```

**対象問題:**
- 特定機能のみ動作不良
- API一部エラー
- パフォーマンス大幅劣化

### 🟢 **レベル3: 軽微な問題 (次回定期対応)**
- UI表示崩れ
- 非重要機能の問題
- パフォーマンス軽微劣化

## 🔍 **よくある問題と解決法**

### 🐛 **開発環境問題**

#### Docker起動しない
```bash
# Docker Desktop確認・起動
open -a Docker

# ポート競合確認
lsof -i :3000
lsof -i :3003

# 環境リセット
npm run docker:reset
```

#### テスト失敗
```bash
# キャッシュクリア
npm run test -- --clearCache

# 依存関係再インストール
rm -rf node_modules package-lock.json
npm install

# 環境変数確認
npm run check:dev
```

#### ビルドエラー
```bash
# TypeScript確認
npm run type-check

# ESLint確認
npm run lint

# 段階的ビルド
npm run build
```

### 🚀 **デプロイ問題**

#### デプロイ失敗
```bash
# 即座ロールバック
npm run deploy:rollback:production

# ログ確認
npm run deploy:logs:production

# 環境状態確認
npm run deploy:status:production
```

#### 環境変数問題
```bash
# Vercel環境変数確認
vercel env list production

# ローカル環境変数確認
cat .env.local
```

#### DNS・SSL問題
```bash
# DNS解決確認
nslookup shiftwith-sigma.vercel.app

# SSL証明書確認
echo | openssl s_client -connect shiftwith-sigma.vercel.app:443 -servername shiftwith-sigma.vercel.app
```

### 💾 **データベース問題**

#### 接続エラー
```bash
# Supabase状態確認
curl -I https://btakhtivpdhieruediwt.supabase.co

# 認証情報確認
echo $SUPABASE_SERVICE_ROLE_KEY

# ローカルDocker確認
docker-compose ps
```

#### データ不整合
```bash
# データベース整合性確認
npm run check:production

# ログ確認
npm run deploy:logs:production | grep -i error
```

## 📋 **診断手順テンプレート**

### 🔍 **問題発生時の基本診断**
1. **問題の特定**
   - 影響範囲の確認
   - 再現性の確認
   - エラーメッセージの記録

2. **環境状態確認**
   ```bash
   npm run check:production      # 本番環境確認
   npm run deploy:status:production  # 詳細状態
   npm run deploy:logs:production    # ログ確認
   ```

3. **原因調査**
   - 最近の変更との関連性
   - 外部サービス状況確認
   - システムリソース確認

4. **対応策決定**
   - 即座ロールバック vs 修正デプロイ
   - 影響範囲の最小化
   - ユーザー通知の必要性

### 🛠️ **復旧作業手順**
1. **緊急対応**
   - サービス停止回避
   - データ保護確保
   - 被害拡大防止

2. **根本対応**
   - 原因の完全解決
   - テスト実施
   - 段階的復旧

3. **事後対応**
   - 再発防止策実装
   - 監視強化
   - ドキュメント更新

## 📞 **エスカレーション基準**

### ⏱️ **時間ベース**
- **5分**: 初動対応開始
- **15分**: チームリーダー報告
- **30分**: マネジメント報告
- **1時間**: 外部サポート検討

### 📊 **影響ベース**
- **全ユーザー影響**: 即座エスカレーション
- **一部ユーザー影響**: 15分後エスカレーション
- **内部のみ影響**: 30分後エスカレーション

## 🔧 **予防保守**

### 📅 **定期チェック項目**
- **日次**: ログ確認、メトリクス確認
- **週次**: 依存関係更新確認
- **月次**: セキュリティアップデート
- **四半期**: システム全体ヘルスチェック

### 📊 **監視アラート設定**
```bash
# アラート条件
- エラー率 > 5%
- 応答時間 > 3秒
- 稼働率 < 99%
- メモリ使用量 > 80%
```

## 📚 **学習・改善**

### 📝 **インシデントレポート作成**
- 発生原因の詳細分析
- 対応時間の記録
- 再発防止策の立案
- チーム共有とナレッジ蓄積

### 🎓 **チーム教育**
- 定期的なトラブルシューティング訓練
- 新しい問題パターンの共有
- 外部事例の学習
- 対応スキル向上

## 🎯 **関連ドキュメント**

### 📖 **詳細手順**
- [../03_デプロイ・運用/15_完全デプロイフロー.md](../03_デプロイ・運用/15_完全デプロイフロー.md) - 正常デプロイフロー
- [../03_デプロイ・運用/17_環境別確認チェックリスト.md](../03_デプロイ・運用/17_環境別確認チェックリスト.md) - 確認項目詳細

### 🔒 **セキュリティ関連**
- [../04_セキュリティ/05_セキュリティ設計.md](../04_セキュリティ/05_セキュリティ設計.md) - セキュリティインシデント対応

## 📞 **緊急連絡先**

### 🚨 **即座連絡（レベル1）**
- 開発チーム: #shiftwith-dev
- オンコール: [電話番号]
- マネジメント: #shiftwith-management

### 📋 **報告・連携（レベル2・3）**
- インフラ: #shiftwith-ops
- ビジネス: #shiftwith-business
- カスタマーサポート: #customer-support

**🚨 迅速で的確な対応により、ユーザー影響を最小化しましょう！**
