# 🚨 緊急環境分離計画

## 📊 **現在の状況**
- 本番環境：ShiftWith（https://shiftwith-sigma.vercel.app）- 運用中
- 開発環境：同じSupabaseプロジェクト使用 ← **危険状態**
- ユーザーデータ：本番に実ユーザーデータ存在

## ⚡ **Phase 1: 緊急対応（今日実行）**

### 1.1 開発用Supabaseプロジェクト作成
```bash
# Supabase Dashboard で新プロジェクト作成
プロジェクト名: shiftwith-development
リージョン: Asia Pacific（ap-northeast-1）
```

### 1.2 開発環境変数分離
```bash
# .env.development.local 作成（git管理外）
NEXT_PUBLIC_SUPABASE_URL=https://[新開発プロジェクトID].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[新開発用アノンキー]
SUPABASE_SERVICE_ROLE_KEY=[新開発用サービスロールキー]

# .env.production.local 作成（git管理外）
NEXT_PUBLIC_SUPABASE_URL=https://btakhtivpdhieruediwt.supabase.co  # 現在の本番
NEXT_PUBLIC_SUPABASE_ANON_KEY=[本番アノンキー]
SUPABASE_SERVICE_ROLE_KEY=[本番サービスロールキー]
```

### 1.3 開発データのセットアップ
```sql
-- 開発用の初期データ投入
-- テストユーザー、サンプル教材の作成
```

## ⚡ **Phase 2: 即座実行（今日中）**

### 2.1 本番Supabase設定の保護強化
```
Authentication > URL Configuration:
- Site URL: https://shiftwith-sigma.vercel.app
- Redirect URLs: https://shiftwith-sigma.vercel.app のみ
- localhost系URL完全削除
```

### 2.2 開発環境の認証設定
```
新開発プロジェクト Authentication > URL Configuration:
- Site URL: http://localhost:3000
- Redirect URLs: 
  - http://localhost:3000/auth/callback
  - http://localhost:3000/welcome
```

### 2.3 Vercelの環境変数設定
```bash
# 本番環境（Vercel）
NEXT_PUBLIC_SUPABASE_URL=https://btakhtivpdhieruediwt.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[本番アノンキー]
SUPABASE_SERVICE_ROLE_KEY=[本番サービスロールキー]
```

## 🔒 **Phase 3: セキュリティ強化（今週中）**

### 3.1 アクセス制御
- 本番プロジェクトのRLS（Row Level Security）強化
- 開発プロジェクトのIP制限設定
- サービスロールキーの定期ローテーション

### 3.2 監視設定
- 本番データベースの変更ログ監視
- 異常アクセスの検知
- 開発環境からの本番アクセス検知

## 🧪 **Phase 4: テスト・検証**

### 4.1 分離後テスト
```javascript
// 本番環境テスト
mcp_playwright-mcp_browser_navigate({ url: "https://shiftwith-sigma.vercel.app" })

// 開発環境テスト  
mcp_playwright-mcp_browser_navigate({ url: "http://localhost:3000" })
```

### 4.2 データ整合性確認
- 本番ユーザーデータの正常性確認
- 開発環境のテストデータ動作確認
- 認証フローの完全分離確認

## 📋 **実行チェックリスト**

### 🚨 緊急対応
- [ ] 開発用Supabaseプロジェクト作成
- [ ] .env.development.local作成
- [ ] .env.production.local作成  
- [ ] 本番Supabase認証設定からlocalhost削除
- [ ] Vercel環境変数確認・更新

### 🔄 継続対応
- [ ] 開発用初期データ投入
- [ ] RLS設定の見直し
- [ ] 開発チーム への周知・教育
- [ ] 監視・ログ設定
- [ ] 定期レビュー体制構築

## ⚠️ **注意事項**
1. **本番環境への影響最小化**: 作業中も本番サービス継続
2. **データバックアップ**: 作業前に本番データの完全バックアップ
3. **段階的実行**: 一度に全て変更せず、段階的に移行
4. **即座ロールバック準備**: 問題発生時の復旧手順準備 