# 🚀 ShiftWith 完全デプロイフロー

## 📋 **概要**
ローカル開発からステージング、本番環境への安全なデプロイフローと、各段階での必須チェック項目をまとめます。

## 🌊 **デプロイフロー全体図**

```mermaid
graph LR
    A[🖥️ ローカル開発<br/>Docker Supabase] --> B[📝 コード完成<br/>テスト完了]
    B --> C[🔀 Pull Request<br/>作成]
    C --> D[👀 コードレビュー<br/>承認]
    D --> E[🧪 ステージング<br/>デプロイ]
    E --> F[✅ ステージング<br/>テスト]
    F --> G[🚀 本番<br/>デプロイ]
    G --> H[🔍 本番<br/>監視]
```

## 🖥️ **Phase 1: ローカル開発環境**

### 🛠️ **開発開始**
```bash
# 1. Docker Supabase起動
docker-compose up -d postgres supabase-rest

# 2. 環境変数設定（ローカル）
NEXT_PUBLIC_SUPABASE_URL=http://localhost:3003
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiJ9.ZopqoUt20nEV9cklpv9jtLgXMv3cJYAYfdv-q2I9t0c

# 3. Next.js開発サーバー起動
npm run dev
```

### ✅ **開発完了チェックリスト**
- [ ] 機能実装完了
- [ ] TypeScript型エラー: 0件 (`npm run type-check`)
- [ ] ESLintエラー: 0件 (`npm run lint`)
- [ ] 単体テスト: 全合格 (`npm test`)
- [ ] 手動動作確認: 主要機能テスト
- [ ] Docker Supabaseでの動作確認

### 🔧 **コミット前最終チェック**
```bash
# 全品質チェック実行
npm run pre-commit

# Git操作
git add .
git commit -m "feat: 新機能実装"
git push origin feature/機能名
```

## 🔀 **Phase 2: Pull Request & レビュー**

### 📝 **PR作成時の必須項目**
```markdown
## 🎯 変更概要
- 実装した機能の詳細
- 解決した問題
- 影響範囲

## ✅ テスト確認
- [ ] TypeScript/ESLint: エラー0件
- [ ] 単体テスト: 全合格
- [ ] 手動動作テスト: 完了
- [ ] ローカル環境での動作確認: 完了

## 🚨 破壊的変更
- データベーススキーマ変更: あり/なし
- API仕様変更: あり/なし
- 環境変数追加: あり/なし

## 📋 デプロイ後確認項目
- [ ] ステージング環境での動作確認
- [ ] 本番環境での動作確認
- [ ] 監視ダッシュボード確認
```

### 👀 **レビュー必須確認項目**
- [ ] コード品質（可読性、保守性）
- [ ] セキュリティ（入力検証、認証）
- [ ] パフォーマンス（N+1クエリ、メモリリーク）
- [ ] テスト網羅度
- [ ] ドキュメント更新
- [ ] 本番環境への影響評価

## 🧪 **Phase 3: ステージング環境デプロイ**

### 🔄 **自動デプロイ設定**
```yaml
# .github/workflows/staging.yml
name: Staging Deploy
on:
  push:
    branches: [ develop ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Staging
        run: |
          # ステージング環境変数設定
          export NEXT_PUBLIC_SUPABASE_URL=${{ secrets.STAGING_SUPABASE_URL }}
          export NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.STAGING_SUPABASE_ANON_KEY }}
          
          # デプロイ実行
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
```

### ✅ **ステージング確認項目**
```bash
# 1. 基本接続確認
curl -I https://staging.shiftwith.app/

# 2. API動作確認
curl -s "https://staging.shiftwith.app/api/profiles"

# 3. 主要機能テスト
# - ユーザー登録/ログイン
# - 教材作成/閲覧
# - ギバースコア計算
# - ダッシュボード表示
```

### 🚨 **ステージング失敗時の対応**
```bash
# 即座にロールバック
vercel rollback staging

# 問題調査
vercel logs staging --limit 100

# 修正後再デプロイ
git commit -m "fix: ステージング問題修正"
git push origin develop
```

## 🚀 **Phase 4: 本番環境デプロイ**

### ⚠️ **本番デプロイ前最終確認**
- [ ] ステージング環境で全機能正常動作
- [ ] データベースマイグレーション計画確認
- [ ] ロールバック手順準備
- [ ] 監視アラート設定確認
- [ ] メンテナンス時間の設定（必要時）

### 🔐 **本番環境変数確認**
```bash
# Vercel本番環境変数（必須）
NEXT_PUBLIC_SUPABASE_URL=https://btakhtivpdhieruediwt.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[本番ANON_KEY]
SUPABASE_SERVICE_ROLE_KEY=[本番SERVICE_ROLE_KEY]
NODE_ENV=production
```

### 🚀 **本番デプロイ実行**
```bash
# mainブランチマージ
git checkout main
git merge develop
git tag v1.0.1  # バージョンタグ
git push origin main --tags

# 本番デプロイ
vercel --prod

# デプロイ完了確認
vercel ls production
```

### ✅ **本番デプロイ後確認項目**

#### 🔍 **即座確認（5分以内）**
```bash
# 1. 基本接続確認
curl -I https://shiftwith-sigma.vercel.app/

# 2. 主要API確認
curl -s "https://shiftwith-sigma.vercel.app/api/profiles"

# 3. ダッシュボード確認
curl -s "https://shiftwith-sigma.vercel.app/dashboard"
```

#### 📊 **詳細確認（30分以内）**
- [ ] 全ページのロード確認
- [ ] ユーザー登録/ログインフロー
- [ ] 教材作成/閲覧機能
- [ ] ギバースコア計算
- [ ] データベース接続確認
- [ ] エラーログ確認（無効アクセス除く）

## 🚨 **緊急時対応フロー**

### 🔴 **重大障害時（サービス停止）**
```bash
# 1. 即座にロールバック（5分以内）
vercel rollback production

# 2. 状況確認
vercel logs production --limit 200
curl -I https://shiftwith-sigma.vercel.app/

# 3. 問題特定・修正
# 4. ホットフィックス作成
git checkout main
git checkout -b hotfix/critical-fix
# 修正作業
git commit -m "hotfix: 緊急修正"
git push origin hotfix/critical-fix

# 5. 緊急マージ・デプロイ
git checkout main
git merge hotfix/critical-fix
vercel --prod
```

### 🟡 **軽微な問題**
- 次回定期デプロイで修正
- 問題レポート作成
- 監視強化

## 📊 **品質ゲート**

### 🎯 **各段階の合格基準**

#### ローカル開発
- TypeScript/ESLintエラー: **0件**
- テストカバレッジ: **80%以上**
- 手動テスト: **主要機能OK**

#### ステージング
- 全機能動作: **100%**
- パフォーマンス: **LCP < 2.5s**
- エラー率: **< 1%**

#### 本番
- 稼働率: **99.9%以上**
- レスポンス時間: **平均 < 1s**
- エラー率: **< 0.1%**

## 🔧 **自動化ツール**

### 📋 **便利スクリプト**
```bash
# package.jsonに追加
"scripts": {
  "deploy:staging": "vercel --target staging",
  "deploy:production": "vercel --prod",
  "rollback:staging": "vercel rollback staging",
  "rollback:production": "vercel rollback production",
  "check:staging": "curl -I https://staging.shiftwith.app/",
  "check:production": "curl -I https://shiftwith-sigma.vercel.app/",
  "logs:staging": "vercel logs staging --limit 50",
  "logs:production": "vercel logs production --limit 50"
}
```

### 🤖 **GitHub Actions設定**
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Type check
        run: npm run type-check
      - name: Lint
        run: npm run lint
      - name: Test
        run: npm test
      - name: Build
        run: npm run build
```

## 📈 **監視・メトリクス**

### 🔍 **重要な監視項目**
- **稼働率**: サービス可用性
- **レスポンス時間**: ユーザー体験
- **エラー率**: システム安定性
- **データベース接続**: バックエンド健全性
- **メモリ使用量**: リソース効率性

### 🚨 **アラート設定**
- エラー率 > 5%: Slack通知
- レスポンス時間 > 5s: メール通知
- サービス停止: 電話通知

## 📝 **デプロイ記録**

### 📊 **デプロイログテンプレート**
```markdown
## デプロイ記録 - v1.0.1

**日時**: 2025-01-15 14:30 JST
**担当者**: [名前]
**ブランチ**: main
**コミット**: abc123def

### 変更内容
- 新機能: ○○機能追加
- 修正: ○○バグ修正
- 改善: ○○パフォーマンス向上

### 確認結果
- [ ] ステージングテスト: OK
- [ ] 本番デプロイ: OK
- [ ] 動作確認: OK
- [ ] 監視確認: OK

### 問題・注意事項
- なし

### ロールバック計画
- 前バージョン: v1.0.0
- ロールバック手順: `vercel rollback production`
```

## 🎯 **ベストプラクティス**

### ✅ **推奨事項**
1. **小さく頻繁なデプロイ**: 大きな変更を避ける
2. **ブルーグリーンデプロイ**: 無停止デプロイ
3. **カナリーリリース**: 段階的展開
4. **自動化重視**: 人的ミスを防ぐ
5. **監視強化**: 問題の早期発見

### ❌ **避けるべき事項**
1. **金曜夜のデプロイ**: 週末対応困難
2. **テスト未実行デプロイ**: 品質リスク
3. **本番直接デプロイ**: ステージング経由必須
4. **ロールバック計画なし**: 緊急対応困難
5. **一人デプロイ**: レビュー不足

---

## 🚀 **まとめ**

このフローにより、**安全で確実なデプロイ**が可能になります：

1. **品質保証**: 各段階での厳密なチェック
2. **リスク最小化**: 段階的デプロイとロールバック準備
3. **効率化**: 自動化による作業削減
4. **透明性**: 完全な記録とトレーサビリティ

常にこのフローに従って、安定したサービス運用を維持しましょう！
