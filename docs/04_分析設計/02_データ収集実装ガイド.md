# データ収集実装ガイド

## 概要
ShiftWithプラットフォームでのデータ収集システムの実装方法と使用例

## データ収集の目的
1. **教材効果の測定**: どの教材がどの程度学習効果があるか
2. **ユーザー行動の理解**: 学習パターン、つまずきポイントの特定
3. **個人最適化**: ユーザー特性に応じた最適な学習体験の提供
4. **コンテンツ改善**: データに基づく教材品質向上

## 実装されたデータ収集項目

### 1. 基本行動ログ (`user_behavior_logs`)
```typescript
// 自動収集される項目
- ページビュー: 各ページの訪問記録
- 滞在時間: ページごとの滞在時間
- クリック行動: クリックされた要素の記録
- スクロール深度: どこまで読んだかの記録
- デバイス情報: 使用デバイス、ブラウザ、画面サイズ
- セッション情報: 訪問開始〜終了の記録
```

### 2. 学習進捗ログ (`material_learning_logs`)
```typescript
// 教材学習時に収集される項目
- 学習開始・完了時刻
- 学習時間の累計
- 最後に見ていた位置
- クイズの挑戦回数・正答数
- 満足度・有用性・難易度の評価
- ブックマーク・推奨の意思
```

### 3. 効果測定指標 (`material_effectiveness_metrics`)
```typescript
// 日次で自動集計される項目
- 基本エンゲージメント: 閲覧数、完了率、離脱率
- インタラクション: コメント数、ハート数、共有数
- 学習効果: 平均スコア、知識定着率、スキル向上度
- 満足度: 評価の平均、推奨率
- レベル・パーソナリティ別効果
```

## 使用方法

### 1. 基本的なページでの使用
```tsx
import { usePageAnalytics } from '@/hooks/useAnalytics';

const MyPage = () => {
  // 基本的なページ分析（ページビュー、スクロールなど自動収集）
  usePageAnalytics();
  
  return <div>ページコンテンツ</div>;
};
```

### 2. 教材詳細ページでの使用
```tsx
import { 
  useLearningSessionTracking, 
  useQuizTracking,
  useCommentTracking 
} from '@/hooks/useAnalytics';

const MaterialDetailPage = ({ materialId }: { materialId: string }) => {
  // 学習セッション追跡
  const { updateProgress, completeSession, bookmarkMaterial } = 
    useLearningSessionTracking(materialId);
  
  // クイズ追跡
  const { startQuiz, submitQuizResult } = useQuizTracking(materialId);
  
  // コメント追跡
  const { startWritingComment, submitComment, voteHelpful } = 
    useCommentTracking(materialId);

  // 学習進捗の更新（スクロール時など）
  const handleScroll = () => {
    const position = calculateCurrentPosition();
    updateProgress(position);
  };

  // 教材完了時の評価
  const handleComplete = (ratings) => {
    completeSession({
      difficulty: ratings.difficulty,
      satisfaction: ratings.satisfaction,
      usefulness: ratings.usefulness,
      will_recommend: ratings.recommend
    });
  };

  // クイズ提出
  const handleQuizSubmit = (result) => {
    submitQuizResult({
      correct_answers: result.correct,
      total_questions: result.total,
      score: result.score
    });
  };

  // コメント投稿
  const handleCommentSubmit = (commentText, parentId?) => {
    submitComment({
      comment_length: commentText.length,
      parent_comment_id: parentId
    });
  };

  // ハート投票
  const handleHelpfulVote = (commentId, isHelpful) => {
    voteHelpful(commentId, isHelpful);
  };

  return (
    <div onScroll={handleScroll}>
      {/* 教材コンテンツ */}
      <MaterialContent onComplete={handleComplete} />
      
      {/* クイズセクション */}
      <QuizSection 
        onStart={startQuiz}
        onSubmit={handleQuizSubmit} 
      />
      
      {/* コメントセクション */}
      <CommentSection 
        onStartWriting={startWritingComment}
        onSubmit={handleCommentSubmit}
        onVoteHelpful={handleHelpfulVote}
      />
    </div>
  );
};
```

### 3. 検索ページでの使用
```tsx
import { useSearchTracking } from '@/hooks/useAnalytics';

const SearchPage = () => {
  const { logSearch } = useSearchTracking();

  const handleSearch = async (query: string, category?: string) => {
    const results = await searchMaterials(query, category);
    
    // 検索結果をログに記録
    logSearch(query, results.length, category);
    
    return results;
  };

  return (
    <SearchInterface onSearch={handleSearch} />
  );
};
```

## データベース設計のポイント

### 1. パフォーマンス最適化
```sql
-- 頻繁にクエリされるカラムにインデックス
CREATE INDEX idx_behavior_logs_user_material ON user_behavior_logs(user_id, material_id);
CREATE INDEX idx_learning_logs_completion ON material_learning_logs(is_completed, created_at);

-- パーティショニング（大量データ対応）
CREATE TABLE user_behavior_logs_2025_01 PARTITION OF user_behavior_logs
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 2. プライバシー保護
```sql
-- RLS (Row Level Security) で本人のデータのみアクセス可能
CREATE POLICY "users_own_data_only" ON user_behavior_logs
  FOR ALL USING (auth.uid() = user_id);

-- 集計データは匿名化
CREATE VIEW anonymous_material_stats AS
SELECT 
  material_id,
  COUNT(*) as view_count,
  AVG(satisfaction_rating) as avg_satisfaction
  -- user_id は含めない
FROM material_learning_logs
GROUP BY material_id;
```

### 3. データ保持ポリシー
```sql
-- 古いログデータの自動削除（例：1年後）
CREATE OR REPLACE FUNCTION cleanup_old_behavior_logs()
RETURNS void AS $$
BEGIN
  DELETE FROM user_behavior_logs 
  WHERE created_at < NOW() - INTERVAL '1 year';
END;
$$ LANGUAGE plpgsql;

-- 定期実行
SELECT cron.schedule('cleanup-behavior-logs', '0 2 * * 0', 'SELECT cleanup_old_behavior_logs()');
```

## 分析用クエリ例

### 1. 教材効果ランキング
```sql
-- 効果的な教材トップ10
SELECT 
  m.title,
  em.completion_rate,
  em.average_satisfaction,
  em.total_helpful_votes,
  em.content_quality_score
FROM materials m
JOIN material_effectiveness_metrics em ON m.id = em.material_id
WHERE em.measurement_date = CURRENT_DATE
ORDER BY em.content_quality_score DESC
LIMIT 10;
```

### 2. ユーザー学習パターン分析
```sql
-- ユーザーの学習時間帯パターン
SELECT 
  EXTRACT(HOUR FROM created_at) as hour_of_day,
  COUNT(*) as session_count,
  AVG(total_time_spent) as avg_time_spent
FROM material_learning_logs
WHERE user_id = $1
  AND created_at >= NOW() - INTERVAL '30 days'
GROUP BY EXTRACT(HOUR FROM created_at)
ORDER BY hour_of_day;
```

### 3. コンテンツタイプ別効果
```sql
-- カテゴリ別の学習効果
SELECT 
  m.category,
  AVG(mll.satisfaction_rating) as avg_satisfaction,
  AVG(CASE WHEN mll.is_completed THEN 1.0 ELSE 0.0 END) as completion_rate,
  COUNT(DISTINCT mll.user_id) as unique_learners
FROM materials m
JOIN material_learning_logs mll ON m.id = mll.material_id
WHERE mll.created_at >= NOW() - INTERVAL '30 days'
GROUP BY m.category
ORDER BY avg_satisfaction DESC;
```

## 実装時の注意点

### 1. パフォーマンス
- **非同期処理**: UI をブロックしないよう分析データ送信は非同期で
- **バッチ処理**: 頻繁な小さなクエリよりバッチでまとめて送信
- **キャッシュ活用**: 集計データはキャッシュして再計算を避ける

### 2. プライバシー
- **最小限の収集**: 分析に必要な最小限のデータのみ収集
- **匿名化**: 個人識別可能な情報は除外または暗号化
- **透明性**: ユーザーに何を収集しているか明示

### 3. データ品質
- **バリデーション**: 収集時にデータの妥当性チェック
- **重複排除**: 同一イベントの重複送信を防ぐ
- **エラーハンドリング**: 収集失敗してもUI は正常動作

## 期待される分析結果

### 1. 教材改善提案
```
【分析結果例】
・「文法解説型」教材は中級者の満足度が高い（4.2/5.0）
・「体験談型」教材は初心者の完了率が高い（78% vs 平均65%）
・3000文字を超える教材は離脱率が上昇（+23%）
・セクション区切りが明確な教材は理解度が向上（+15%）

【改善提案】
→ 初心者向けには体験談を多く含める
→ 長文教材は複数セクションに分割
→ 中級者向けには詳細な文法解説を追加
```

### 2. 個人最適化
```
【学習者プロファイル例】
・学習タイプ: 視覚学習優位
・最適時間帯: 朝6-8時、夜20-22時
・好みの長さ: 短時間集中型（10-15分）
・効果的構造: 例→説明→練習の順序

【推奨設定】
→ 図表多めの教材を優先表示
→ 朝夕の時間に学習リマインダー
→ 15分以内の教材を中心に推奨
→ 実例豊富な教材タイプを提案
```

このデータ収集システムにより、ShiftWithは継続的に改善し、
より効果的な学習体験を提供できるようになります。
