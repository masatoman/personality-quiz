# ShiftWith 機能仕様書

## 関連ドキュメント

- [基本設計](./01_基本設計.md) - プロジェクトの全体像と基本コンセプト
- [情報設計](./03_情報設計.md) - サイトマップとユーザーフロー
- [テスト標準](../02_開発ガイド/02_テスト標準.md) - テスト作成の標準ルール

## 目次

1. [はじめに](#はじめに)
2. [ギバー診断システム](#ギバー診断システム)
3. [ポイントシステム](#ポイントシステム)
4. [教材システム](#教材システム)
5. [ユーザーダッシュボード](#ユーザーダッシュボード)
6. [認証システム](#認証システム)
7. [APIシステム](#APIシステム)
8. [データベース設計](#データベース設計)

## はじめに

この文書はShiftWithアプリケーションの機能仕様を詳細に記述するものです。実装チームはこの仕様に従って開発を行います。

### 背景

ShiftWithは「教えることで学ぶ」という原則を基に、ギバー行動（教材作成、フィードバック提供など）を促進し、ユーザーの英語学習効果を高めるアプリケーションです。

### 対象読者

- 開発チーム
- テストチーム
- プロジェクト管理者
- ステークホルダー

### 文書の構成

各機能セクションは以下の構造で記述されています：

1. **概要** - 機能の全体像
2. **ユーザーストーリー** - 機能が解決する具体的なユーザーニーズ
3. **要件** - 機能の詳細な要件リスト
4. **UIワイヤーフレーム** - UI要素の説明
5. **データモデル** - 関連するデータ構造
6. **振る舞い** - 機能の動作フロー
7. **例外処理** - エラーケースと対応方法
8. **テスト条件** - 機能検証のためのテストケース

## ギバー診断システム

### 概要

ギバー診断システムは、ユーザーの心理的特性を分析し、「ギバー」（貢献者）、「マッチャー」（互恵主義者）、「テイカー」（獲得者）のどのタイプに近いかを判定するテストシステムです。この診断結果を基に、ユーザーのギバー行動を促進し、学習効果を高めるためのパーソナライズされた体験を提供します。

### ユーザーストーリー

1. **新規ユーザーとして**、自分の学習スタイルや性格特性を客観的に理解したいので、簡単な診断テストを受けて自己分析を行いたい。
2. **学習者として**、自分の強みと改善点を知りたいので、ギバースコアとその内訳を確認したい。
3. **継続ユーザーとして**、自分の成長を実感したいので、ギバースコアの変化を時系列で確認したい。

### 要件

#### 1. 診断テスト

- **1.1** ユーザーは初回ログイン時に診断テストを受ける
- **1.2** テストは合計15問の質問で構成される
- **1.3** 各質問は3〜5つの選択肢から1つを選ぶ形式
- **1.4** 質問は分割して表示し、一度に3〜5問ずつ回答
- **1.5** 各回答に応じてスコアを計算
- **1.6** テスト途中での中断・再開が可能

#### 2. ギバー診断ロジック

- **2.1** 回答結果から0-100点のギバースコアを計算
  - 0-33点：テイカー傾向
  - 34-66点：マッチャー傾向
  - 67-100点：ギバー傾向
- **2.2** スコア計算は以下の5つのサブカテゴリに分類
  - 知識共有の積極性
  - フィードバック提供の質
  - 協力意識
  - 利他性
  - 教える意欲
- **2.3** 総合スコアとサブカテゴリスコアを保存

#### 3. 診断結果表示

- **3.1** タイプ判定結果をビジュアル表示（ギバー、マッチャー、テイカー）
- **3.2** 総合スコアをゲージで表示
- **3.3** 5つのサブカテゴリのスコアをレーダーチャートで表示
- **3.4** タイプ別の特徴と強みを表示
- **3.5** 英語学習における推奨アプローチを提示
- **3.6** 結果に基づいた次のアクションを提案

#### 4. ポイント連携

- **4.1** 診断テスト完了時に20ポイントを付与
- **4.2** ポイント付与はユーザーごとに初回のみ

### データモデル

```sql
-- ギバー診断結果テーブル
CREATE TABLE giver_diagnoses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  total_score INTEGER NOT NULL CHECK (total_score BETWEEN 0 AND 100),
  knowledge_sharing_score INTEGER CHECK (knowledge_sharing_score BETWEEN 0 AND 100),
  feedback_quality_score INTEGER CHECK (feedback_quality_score BETWEEN 0 AND 100),
  cooperation_score INTEGER CHECK (cooperation_score BETWEEN 0 AND 100),
  altruism_score INTEGER CHECK (altruism_score BETWEEN 0 AND 100),
  teaching_willingness_score INTEGER CHECK (teaching_willingness_score BETWEEN 0 AND 100),
  primary_type TEXT CHECK (primary_type IN ('giver', 'matcher', 'taker')),
  test_version TEXT DEFAULT '1.0'
);

-- 診断回答履歴テーブル
CREATE TABLE diagnosis_answers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  diagnosis_id UUID REFERENCES giver_diagnoses(id) NOT NULL,
  question_id INTEGER NOT NULL,
  answer_value INTEGER NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### UIワイヤーフレーム

#### 診断テスト画面

- ヘッダー：「ギバー診断テスト」タイトル、進捗表示
- テスト説明：目的と概要の簡潔な説明
- 質問表示エリア：現在の質問と選択肢を表示
- 回答ボタン：各選択肢に対応
- 進捗バー：全15問中の現在位置
- ナビゲーションボタン：「次へ」「戻る」

#### 診断結果画面

- 結果サマリー：「あなたは〇〇タイプです」
- スコア表示：総合スコアのビジュアル表示（円グラフ）
- サブカテゴリスコア：レーダーチャート表示
- 特徴解説：タイプ別の特徴と強みの解説
- 学習アドバイス：タイプに合わせた学習アプローチ
- アクションボタン：「詳細を見る」「ダッシュボードへ」

### 振る舞い

1. ユーザーが初回ログイン時またはギバー診断メニューを選択
2. 診断テスト開始前の説明画面表示
3. ユーザーが「開始」をクリック
4. 最初の質問セット（3〜5問）を表示
5. ユーザーが全質問に回答
6. 「次へ」ボタンで次の質問セットへ
7. 全15問回答後、「結果を見る」ボタン表示
8. 回答結果を処理し、スコア計算
9. 診断結果画面表示
10. ポイント付与通知を表示
11. ユーザーのアクション選択に応じて遷移

### 例外処理

- **テスト中断時**：回答状態を保存し、再開時にはその時点から継続可能
- **回答未選択時**：「次へ」ボタンは非活性化
- **エラー発生時**：エラーメッセージ表示と「やり直す」オプション提供
- **ネットワーク切断時**：ローカルに一時保存し、再接続時に送信

### テスト条件

#### 単体テスト

- 各質問の表示と選択肢レンダリング
- スコア計算ロジックの正確性
- タイプ判定ロジックの正確性
- 各サブカテゴリスコアの計算

#### 結合テスト

- 質問間の遷移
- 回答データの保存
- 結果表示と計算値の一致

#### E2Eテスト

- 完全な診断フロー（開始から結果表示まで）
- ポイント付与の確認
- 中断と再開のシナリオ

## ポイントシステム

### 概要

ポイントシステムは、ユーザーのギバー行動を促進し、継続的な学習モチベーションを維持するための報酬メカニズムです。ユーザーは教材作成、教材利用、フィードバック提供などのアクションによってポイントを獲得し、特典と交換したり、プレミアムコンテンツへのアクセス権を得たりすることができます。

### ユーザーストーリー

1. **教材作成者として**、自分の作った教材が他者の役に立っていることを実感したいので、教材作成・利用に応じたポイント獲得状況を確認したい。
2. **学習者として**、学習へのモチベーションを高めたいので、学習活動に応じたポイントを獲得してレベルアップしたい。
3. **プラットフォーム利用者として**、自分の貢献度を可視化したいので、累積ポイントと使用可能ポイントの状況を確認したい。

### 要件

#### 1. ポイント獲得

- **1.1** 以下のアクションでポイントを獲得
  - 教材作成：50ポイント/件
  - 教材利用完了：5ポイント/件
  - フィードバック提供：10ポイント/件
  - ギバー診断完了：20ポイント（初回のみ）
  - デイリーログイン：3ポイント/日
- **1.2** 獲得ポイントはユーザープロフィールに即時反映
- **1.3** ポイント獲得時にはポップアップ通知を表示
- **1.4** ポイント履歴はユーザーがいつでも確認可能

#### 2. ポイント消費

- **2.1** 以下のアクションでポイントを消費
  - プレミアム教材の閲覧：50〜100ポイント/件
  - プロフィール強化機能：30ポイント
  - 特殊バッジの獲得：100ポイント
- **2.2** ポイント消費前に確認ダイアログを表示
- **2.3** 保有ポイント不足時は代替アクションを提案
- **2.4** ポイント消費履歴は閲覧可能

#### 3. ギバースコア連携

- **3.1** 獲得したポイントに基づいてギバースコアを計算
  - ポイント獲得の種類による重み付け
  - 時間経過による減衰要素の考慮
- **3.2** ギバースコアは日次バッチ処理で更新
- **3.3** ギバースコアの変動はグラフで可視化
- **3.4** スコア閾値によるレベル区分を設定

#### 4. ポイント管理

- **4.1** ポイント履歴テーブルにすべての取引を記録
- **4.2** ユーザープロフィールに累計・利用可能ポイントを表示
- **4.3** 管理者向けポイント調整機能を実装
- **4.4** 不正取引検知メカニズムを導入

### データモデル

```sql
-- ポイント履歴テーブル
CREATE TABLE points_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  points_amount INTEGER NOT NULL,
  transaction_type TEXT CHECK (transaction_type IN ('earn', 'spend', 'expire', 'adjust')),
  source_type TEXT NOT NULL,
  source_id UUID,
  description TEXT,
  metadata JSONB
);

-- ポイント合計ビュー（参照用）
CREATE VIEW user_points_summary AS
SELECT 
  user_id,
  SUM(CASE WHEN transaction_type = 'earn' THEN points_amount ELSE 0 END) AS total_earned,
  SUM(CASE WHEN transaction_type = 'spend' THEN points_amount ELSE 0 END) AS total_spent,
  SUM(CASE WHEN transaction_type = 'expire' THEN points_amount ELSE 0 END) AS total_expired,
  SUM(CASE WHEN transaction_type = 'adjust' THEN points_amount ELSE 0 END) AS total_adjusted,
  SUM(CASE 
        WHEN transaction_type = 'earn' THEN points_amount 
        WHEN transaction_type IN ('spend', 'expire') THEN -points_amount
        ELSE points_amount
      END) AS available_points
FROM points_history
GROUP BY user_id;
```

### UIワイヤーフレーム

#### ポイント表示コンポーネント

- ヘッダー部：現在の利用可能ポイント（大きく表示）
- ポイント獲得通知：アクション完了時のポップアップ
- ポイント獲得進捗バー：次のレベルまでの残りポイント

#### ポイント履歴画面

- フィルターオプション：期間、取引タイプ
- 履歴リスト：日時、アクション、ポイント増減
- 集計サマリー：期間内の獲得/消費合計
- グラフ表示：ポイント推移チャート

#### ポイント使用画面

- 使用可能コンテンツ/特典リスト
- 各項目のポイントコスト表示
- 「ポイントを使用」ボタン
- 確認ダイアログ：使用内容と消費ポイント

### 振る舞い

1. ユーザーがポイント獲得アクション（教材作成など）を完了
2. システムがポイント付与条件を検証
3. ポイント履歴テーブルに取引レコード追加
4. ユーザーに獲得ポイントの通知表示
5. ユーザープロフィールのポイント表示を更新
6. ギバースコア計算のための指標として記録
7. ユーザーがポイント履歴を確認可能

### 例外処理

- **重複付与防止**：同一アクションに対するポイント重複付与を防止するチェック
- **不正アクション検知**：短時間での異常なポイント獲得パターンを検出
- **ポイント不足時**：ポイント不足エラーメッセージと獲得方法の提案
- **バッチ処理失敗時**：手動再計算オプションの提供と管理者通知

### テスト条件

#### 単体テスト

- 各アクションのポイント計算ロジック
- ポイント付与・消費の取引記録
- ユーザープロフィールのポイント更新

#### 結合テスト

- 教材作成からポイント付与までのフロー
- ポイント消費から特典提供までのフロー
- ギバースコア計算との連携

#### E2Eテスト

- 完全なユーザーフロー（アクション〜ポイント獲得〜使用）
- ポイント残高の正確な計算と表示
- 通知システムとの連携

## 教材システム

### 概要

教材システムは、ユーザーが英語学習教材を作成・共有・利用するための中核機能です。「教えることで学ぶ」というコンセプトに基づき、ユーザーは自分の知識を教材として構造化して共有することで自身の学習を深め、同時に他者の学習を支援することができます。

### ユーザーストーリー

1. **学習者として**、自分のレベルと興味に合った質の高い教材を見つけたいので、効果的に検索・フィルタリングして教材を探したい。
2. **教材作成者として**、自分の知識を整理し共有したいので、使いやすいツールで教材を作成・編集したい。
3. **継続学習者として**、学習の進捗を把握したいので、完了した教材と進行中の教材を追跡したい。

### 要件

#### 1. 教材作成機能

- **1.1** シンプルな2ステップ作成フロー
  - **ステップ1**: 基本情報入力（タイトル・説明・カテゴリ・難易度）
  - **ステップ2**: コンテンツ作成（テキスト・クイズ）
- **1.2** テキストコンテンツ作成
  - マークダウン形式のテキスト編集
  - 段落・見出し・リスト
  - 文字装飾（太字・斜体・下線）
  - 引用・コード表示
- **1.3** 教材メタデータ設定
  - タイトル（必須）
  - 説明文（必須）
  - カテゴリ選択（必須）
  - 難易度設定（初級・中級・上級）
- **1.4** クイズ機能
  - 選択式問題の作成
  - 複数の回答選択肢設定
  - 正解/不正解の判定機能
- **1.5** プレミアム機能案内
  - 画像・動画アップロード：有料プラン限定として案内表示
  - 音声録音機能：有料プラン限定として案内表示
  - 高度な編集機能：将来のアップグレード項目として表示
- **1.6** 公開機能
  - 即座に公開（下書き機能は最小限）
  - 公開完了時のトーストメッセージ表示

#### 2. 教材閲覧機能

- **2.1** 教材一覧表示
  - 新着順・人気順・関連度順
  - カテゴリ・難易度・タグによるフィルタリング
  - キーワード検索
- **2.2** 教材詳細表示
  - ヘッダー（タイトル・作成者・メタデータ）
  - 目次（セクション一覧）
  - コンテンツ表示
  - 関連教材推薦
- **2.3** 学習進捗管理
  - セクション完了マーキング
  - 確認クイズの回答と採点
  - 進捗率の表示（％）
  - 前回の続きから再開

#### 3. 教材評価機能（フェーズ1用意）

- **3.1** 基本的な評価機能
  - いいね/ブックマーク
  - 学習完了マーキング
  - 使用回数カウント
- **3.2** 詳細評価（フェーズ1で完全実装）
  - 5段階評価
  - テキストレビュー
  - 有用性の評価

#### 4. ポイント連携

- **4.1** 教材作成時に50ポイント付与
- **4.2** 教材利用（完了）時に5ポイント付与
- **4.3** プレミアム教材の閲覧には50〜100ポイントを消費

### データモデル

```sql
-- 教材テーブル
CREATE TABLE materials (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  content JSONB NOT NULL,
  category TEXT NOT NULL,
  difficulty_level TEXT CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
  tags TEXT[],
  thumbnail_url TEXT,
  is_published BOOLEAN DEFAULT FALSE,
  is_premium BOOLEAN DEFAULT FALSE,
  premium_point_cost INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  view_count INTEGER DEFAULT 0,
  completion_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0
);

-- 教材セクションテーブル
CREATE TABLE material_sections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  material_id UUID REFERENCES materials(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  sort_order INTEGER NOT NULL,
  content JSONB NOT NULL,
  has_quiz BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 教材クイズテーブル
CREATE TABLE material_quizzes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  section_id UUID REFERENCES material_sections(id) ON DELETE CASCADE,
  question TEXT NOT NULL,
  quiz_type TEXT CHECK (quiz_type IN ('multiple_choice', 'text_input')),
  options JSONB,
  correct_answer TEXT,
  explanation TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 学習進捗テーブル
CREATE TABLE learning_progress (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  material_id UUID REFERENCES materials(id) NOT NULL,
  last_accessed_section_id UUID REFERENCES material_sections(id),
  completed_section_ids UUID[],
  quiz_results JSONB,
  progress_percentage INTEGER DEFAULT 0,
  is_completed BOOLEAN DEFAULT FALSE,
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, material_id)
);
```

### UIワイヤーフレーム

#### 教材作成画面

- ヘッダー：アクションボタン（保存・プレビュー・公開）
- メタデータ入力：タイトル・説明・カテゴリ・難易度選択UI
- リッチテキストエディタ：ツールバー付きの編集領域
- セクション管理：セクション追加・編集・削除UI
- クイズ作成：クイズタイプ選択・問題入力・解答設定
- サイドバー：教材構造のアウトライン表示

#### 教材一覧画面

- 検索・フィルターバー：検索窓とカテゴリフィルター
- 並べ替えオプション：新着順・人気順など
- 教材カードグリッド：サムネイル・タイトル・作成者・メタデータ
- ページネーション：次のページへのナビゲーション
- サイドバー：カテゴリ一覧・人気タグクラウド

#### 教材詳細画面

- ヘッダー：タイトル・作成者情報・メタデータ・アクションボタン
- 進捗表示：プログレスバー（全体の進捗%）
- 目次：セクション一覧（完了マーク付き）
- コンテンツ領域：教材本文の表示
- ナビゲーション：前後のセクションへの移動ボタン
- クイズ表示：問題と回答フォーム
- フッター：関連教材の推薦

### 振る舞い

#### 教材作成フロー

1. ユーザーが「教材作成」メニュー選択
2. 新規教材の基本情報入力画面表示
3. メタデータ入力（タイトル・説明など）
4. リッチテキストエディタでコンテンツ作成
5. セクション追加・編集
6. クイズ追加（オプション）
7. 下書き保存またはプレビュー表示
8. 公開前の最終確認
9. 公開設定（無料/プレミアム）の選択
10. 公開完了とポイント付与通知

#### 教材閲覧フロー

1. 教材一覧または検索から教材選択
2. 教材詳細ページ表示
3. プレミアム教材の場合は確認ダイアログ表示
4. コンテンツ閲覧
5. セクション間の移動
6. クイズ回答と結果表示
7. 完了セクションの自動マーキング
8. 教材完了時に完了バッジとポイント付与通知
9. 関連教材の推薦表示

### 例外処理

- **未保存内容の処理**：ブラウザ閉じる/ページ移動時の警告と自動保存
- **コンテンツ読み込み失敗**：再読み込みオプションの提供
- **権限不足エラー**：プレミアム教材閲覧時のポイント不足通知
- **コンテンツ更新競合**：同時編集検知と解決方法の提示
- **画像アップロード失敗**：代替アップロード方法の提案
- **オフライン状態**：ローカルストレージへの一時保存と再接続時の同期

### テスト条件

#### 単体テスト

- リッチテキストエディタの各機能
- クイズ作成と採点ロジック
- 進捗計算アルゴリズム
- 教材のフィルタリングと検索機能

#### 結合テスト

- 教材作成と保存プロセス
- 教材閲覧と進捗更新の連携
- ポイントシステムとの連携

#### E2Eテスト

- 教材作成から公開までの完全フロー
- 学習者が教材を閲覧・完了するフロー
- プレミアム教材の購入と閲覧フロー

## ユーザーダッシュボード

### 概要

ユーザーダッシュボードは、ユーザーの学習活動、ギバースコア、ポイント状況、進捗などを一元的に可視化する個人向けのホームページです。ユーザーの活動を透明化し、継続的な学習とギバー行動のモチベーションを高めるための中核インターフェースとして機能します。

### ユーザーストーリー

1. **定期的な学習者として**、自分の進捗状況を一目で確認したいので、学習活動の統計とトレンドを視覚的に把握できるダッシュボードが欲しい。
2. **教材作成者として**、自分の貢献が他者にどう活用されているかを知りたいので、作成教材の利用状況を追跡したい。
3. **目標志向の学習者として**、次に何をすべきか指針が欲しいので、パーソナライズされた学習推薦を受け取りたい。
4. **習慣形成を目指す学習者として**、日々の学習タスクを管理したいので、簡単にチェックできるTodoリストが欲しい。

### 要件

#### 1. 活動サマリーセクション

- **1.1** ユーザープロフィール情報表示
  - プロフィール画像
  - ユーザー名
  - ギバータイプ（アイコン表示）
  - 現在のレベル/ランク
- **1.2** 活動統計の数値表示
  - 作成した教材数
  - 利用した教材数
  - 累計学習時間
  - 獲得ポイント総数
- **1.3** アクティビティストリーム
  - 最近の学習活動
  - 最近の教材作成活動
  - ポイント獲得履歴（直近5件）

#### 2. 進捗可視化セクション

- **2.1** ギバースコアの表示
  - 現在のスコア（数値・ゲージ表示）
  - スコア推移グラフ（週単位・月単位で切替）
  - サブカテゴリスコアのレーダーチャート
- **2.2** 学習進捗の表示
  - カテゴリ別の学習進捗
  - 設定した学習目標への進捗
  - 完了率のビジュアライゼーション
- **2.3** 活動分析グラフ
  - 活動種類別の円グラフ
  - 週間活動量の棒グラフ
  - 時間帯別の活動ヒートマップ

#### 3. パーソナライズドレコメンデーション

- **3.1** おすすめ教材の表示
  - ユーザーの学習傾向に基づく推薦
  - ギバータイプに適した教材提案
  - 最近の活動に関連する教材
- **3.2** 今日のタスク提案
  - 学習継続のためのタスク
  - ギバースコア向上のための行動提案
  - 未完了コンテンツの継続促進
  - ギバータイプに応じたカスタムタスク
  - ユーザー自身によるタスク追加・編集機能
  - タスク完了によるポイント獲得連携
- **3.3** 目標設定と管理
  - 短期/長期学習目標の設定
  - 目標達成度の表示
  - 目標に対するマイルストーン

#### 4. クイックアクションメニュー

- **4.1** 主要機能へのショートカット
  - 新規教材作成
  - 教材検索
  - ポイント履歴確認
  - ギバー診断結果確認
- **4.2** 通知センター
  - 未読通知の表示
  - システムメッセージ
  - アチーブメント獲得通知
- **4.3** クイック設定
  - ダッシュボードカスタマイズ
  - 通知設定
  - 表示言語切替

### データモデル

```sql
-- ダッシュボード設定テーブル
CREATE TABLE dashboard_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  layout_config JSONB DEFAULT '{"widgets": ["activity", "progress", "recommendations", "quick_actions"]}',
  visible_widgets TEXT[] DEFAULT ARRAY['activity', 'progress', 'recommendations', 'quick_actions'],
  widget_positions JSONB,
  theme TEXT DEFAULT 'light',
  last_modified TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id)
);

-- 学習目標テーブル
CREATE TABLE learning_goals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  goal_type TEXT CHECK (goal_type IN ('daily', 'weekly', 'monthly', 'custom')),
  target_value INTEGER,
  current_value INTEGER DEFAULT 0,
  measurement_unit TEXT NOT NULL,
  start_date TIMESTAMP WITH TIME ZONE NOT NULL,
  end_date TIMESTAMP WITH TIME ZONE,
  is_completed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 活動ログテーブル（分析用）
CREATE TABLE activity_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  activity_type TEXT NOT NULL,
  resource_type TEXT,
  resource_id UUID,
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### UIワイヤーフレーム

#### ダッシュボードメイン画面

- ヘッダー：ユーザー情報とクイックアクション
- グリッドレイアウト：各セクションをウィジェットとして配置
- レスポンシブデザイン：デバイスサイズに応じたレイアウト変更
- カスタマイズボタン：ウィジェットの追加・削除・並べ替え

#### 活動サマリーウィジェット

- プロフィールカード：ユーザー情報とギバータイプ
- 数値統計：4つの主要指標をタイル表示
- タイムライン：最近の活動を時系列で表示
- 「詳細を見る」リンク：詳細ページへの遷移

#### 進捗可視化ウィジェット

- タブ切り替え：「ギバースコア」「学習進捗」「活動分析」
- グラフ表示エリア：選択したデータの可視化
- 期間フィルター：表示期間の変更オプション
- データポイント詳細：ホバー時の詳細情報表示

#### レコメンデーションウィジェット

- カルーセル表示：おすすめ教材のスライド
- タスクリスト：チェックボックス付きの今日のタスク
  - タスク名とポイント表示
  - 完了/未完了の視覚的表示
  - 追加/削除インターフェース
  - カスタムタスク入力フォーム
- 目標進捗バー：設定した目標への進捗表示
- アクションボタン：「始める」「続ける」などの行動喚起

### 振る舞い

1. ユーザーがダッシュボードページにアクセス
2. 個人データのロードと表示（プログレスアニメーション）
3. 各ウィジェットの非同期読み込み
4. ユーザーアクションに応じたリアルタイム更新
5. ウィジェット間の連携（関連データのハイライト）
6. セッション継続中の自動データ更新（定期的なポーリング）
7. ウィジェットの折りたたみ/展開の状態保存
8. レスポンシブな表示調整（デバイスサイズ変更時）

#### パーソナライズドタスク生成フロー

1. ユーザーのギバータイプと過去の活動履歴を分析
2. ギバータイプに基づいた推奨タスクを生成
   - ギバータイプ：コンテンツ作成タスク
   - マッチャータイプ：フィードバック提供タスク
   - テイカータイプ：学習完了タスク
3. ギバースコアに基づいたレベル別タスクを追加
4. 基本的なデイリータスク（教材閲覧など）を追加
5. ユーザーによる手動タスク追加を許可
6. タスク完了状態の永続化とポイント付与
7. 完了タスクの視覚的フィードバック

### 例外処理

- **データ読み込み失敗**：部分的な表示とリトライオプション
- **アクティビティなし**：初期ユーザー向けのガイダンス表示
- **目標未設定**：目標設定の提案UI表示
- **ブラウザ互換性問題**：代替表示モードの提供
- **低速接続**：データの段階的ロードと優先順位付け
- **セッションタイムアウト**：自動再認証と状態保持

### テスト条件

#### 単体テスト

- 各ウィジェットのレンダリング
- データ取得と表示ロジック
- フィルタリングと期間選択機能
- レスポンシブ表示のブレークポイント
- タスク追加・編集・削除機能
- タスク完了状態の切り替え機能
- ギバータイプ別タスク生成ロジック

#### 結合テスト

- ウィジェット間のデータ連携
- ユーザーアクション後の状態更新
- 各サブシステム（ポイント、教材など）との連携

#### E2Eテスト

- 完全なダッシュボード読み込みと操作フロー
- カスタマイズ機能の保存と適用
- クロスデバイスでの表示と機能確認

## 認証システム

### 概要

認証システムは、ShiftWithアプリケーションへのアクセス制御、ユーザー登録、ログイン・ログアウト、権限管理などのセキュリティ機能を提供します。Supabaseを活用した堅牢な認証基盤を構築し、ユーザーデータの保護とシームレスなユーザー体験を両立させます。

### ユーザーストーリー

1. **新規ユーザーとして**、簡単に登録してアプリを利用したいので、直感的な登録プロセスと複数の認証オプションが欲しい。
2. **既存ユーザーとして**、安全かつ簡単にログインしたいので、セキュアで使いやすい認証方法が欲しい。
3. **モバイルユーザーとして**、デバイス間でシームレスに認証状態を維持したいので、持続的なセッション管理が欲しい。

### 要件

#### 1. ユーザー登録機能

- **1.1** 複数の登録方法を提供
  - メールアドレス + パスワード
  - Google アカウント連携
  - Apple アカウント連携（モバイルユーザー向け）
- **1.2** 登録フォームのバリデーション
  - メールアドレスの形式確認
  - パスワード強度チェック（最低8文字、大文字・小文字・数字・特殊文字の組み合わせ）
  - ユーザー名の一意性確認
- **1.3** メール確認プロセス
  - 確認メールの自動送信
  - メール内の確認リンクによる検証
  - 未確認アカウントの制限付きアクセス
- **1.4** 初回ログイン時のオンボーディング
  - プロフィール情報入力
  - ギバー診断への誘導
  - 利用規約とプライバシーポリシーの同意確認

#### 2. ログイン機能

- **2.1** 複数のログイン方法
  - メールアドレス + パスワード
  - ソーシャルログイン（Google、Apple）
  - 「ログイン状態を保持する」オプション
- **2.2** セキュリティ対策
  - 連続ログイン失敗時のアカウントロック
  - デバイス認証（新しいデバイスからのログイン時に確認）
  - 不審なログイン検知と通知
- **2.3** パスワードリセット
  - メールによるリセットリンク送信
  - 安全なパスワード変更フロー
  - 変更完了通知

#### 3. セッション管理

- **3.1** JWTベースの認証
  - アクセストークンとリフレッシュトークンの発行
  - トークンの有効期限設定（アクセストークン：1時間、リフレッシュトークン：2週間）
  - トークンの自動更新メカニズム
- **3.2** マルチデバイス対応
  - デバイス間でのセッション同期
  - アクティブセッション一覧の表示
  - リモートログアウト機能
- **3.3** セキュアなストレージ
  - トークンの安全な保存（HttpOnly Cookie、LocalStorage）
  - セッション状態の暗号化
  - ログアウト時のクリーンアップ

#### 4. 権限管理

- **4.1** ロールベースのアクセス制御
  - 一般ユーザー
  - 教材作成者
  - モデレーター
  - 管理者
- **4.2** 機能別アクセス制御
  - コンテンツ編集権限
  - プレミアムコンテンツアクセス権限
  - 管理機能アクセス権限
- **4.3** データレベルのセキュリティ
  - Row Level Security (RLS)の実装
  - ユーザー固有データへのアクセス制限
  - 共有データの適切な公開範囲設定

### データモデル

```sql
-- ユーザープロフィールテーブル（Supabase Authと連携）
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  username TEXT UNIQUE,
  display_name TEXT,
  bio TEXT,
  avatar_url TEXT,
  email_notifications BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_active_at TIMESTAMP WITH TIME ZONE,
  is_onboarded BOOLEAN DEFAULT FALSE
);

-- ユーザーロールテーブル
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  role TEXT CHECK (role IN ('user', 'creator', 'moderator', 'admin')) DEFAULT 'user',
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  granted_by UUID REFERENCES auth.users(id),
  UNIQUE(user_id, role)
);

-- セッション監査テーブル
CREATE TABLE auth_sessions_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  session_id TEXT NOT NULL,
  ip_address TEXT,
  user_agent TEXT,
  device_info JSONB,
  login_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  logout_at TIMESTAMP WITH TIME ZONE,
  is_active BOOLEAN DEFAULT TRUE
);
```

### UIワイヤーフレーム

#### 登録画面

- ロゴとウェルカムメッセージ
- 登録フォーム（メール、パスワード、パスワード確認）
- ソーシャルログインボタン
- 利用規約とプライバシーポリシーへのリンク
- 「既にアカウントをお持ちの方」ログインリンク
- エラーメッセージ表示エリア

#### ログイン画面

- ロゴと歓迎メッセージ
- ログインフォーム（メール、パスワード）
- 「ログイン状態を保持する」チェックボックス
- 「パスワードをお忘れですか？」リンク
- ソーシャルログインボタン
- 「アカウントをお持ちでない方」登録リンク

#### プロフィール・セキュリティ設定画面

- タブ切り替え：「基本情報」「セキュリティ」「通知」
- パスワード変更フォーム
- アクティブセッション一覧
- ログアウトオプション（このデバイスのみ/すべてのデバイス）
- 二要素認証設定（将来実装）

### 振る舞い

#### 登録フロー

1. ユーザーが登録画面にアクセス
2. 登録方法を選択（メール/Google/Apple）
3. メール登録の場合：
   a. フォーム入力
   b. バリデーションチェック
   c. 登録ボタンクリック
   d. 確認メール送信
   e. ユーザーがメール内のリンクをクリック
   f. アカウント有効化
4. ソーシャル登録の場合：
   a. プロバイダの認証画面へリダイレクト
   b. 認証・権限承認
   c. コールバック処理
   d. アカウント作成/連携
5. 初回ログイン（オンボーディング）
6. ギバー診断への誘導

#### ログインフロー

1. ユーザーがログイン画面にアクセス
2. 認証方法を選択（メール/Google/Apple）
3. 認証情報入力またはプロバイダ認証
4. 認証成功時：
   a. JWTトークン発行
   b. セッション情報の保存
   c. ダッシュボードへリダイレクト
5. 認証失敗時：
   a. エラーメッセージ表示
   b. 再試行またはパスワードリセットへの誘導

#### ログアウトフロー

1. ユーザーがログアウトボタンをクリック
2. 確認ダイアログ表示（オプション）
3. ローカルストレージ/クッキーのクリア
4. セッション終了処理（バックエンド）
5. ログイン画面へのリダイレクト

### 例外処理

- **メール未確認エラー**：アカウント有効化リマインダーとメール再送オプション
- **認証失敗エラー**：適切なエラーメッセージ（パスワード不一致、アカウント不存在など）
- **アカウントロック**：一時的なロックとロック解除手順の案内
- **セッション期限切れ**：自動再認証または再ログイン誘導
- **同時ログイン競合**：マルチデバイスでのセッション管理と通知
- **不正アクセス検知**：セキュリティアラートとアカウント保護ステップの案内

### テスト条件

#### 単体テスト

- 各認証方法の正常フロー
- バリデーションロジック
- トークン生成と検証
- 権限チェックメカニズム

#### 結合テスト

- 認証情報とユーザープロフィールの連携
- ロールベースのアクセス制御
- セッション管理と自動更新

#### セキュリティテスト

- ブルートフォース攻撃への耐性
- CSRFトークン検証
- XSS対策の有効性
- セッション固定化攻撃への対策
- JWT署名の検証

## APIシステム

### 概要

APIシステムは、フロントエンドアプリケーションとバックエンドサービス間の通信を担当するRESTful APIの集合です。Supabaseのバックエンドサービスと直接連携し、クライアントアプリケーションがデータの取得、作成、更新、削除を安全かつ効率的に行えるようにします。

### ユーザーストーリー

1. **フロントエンド開発者として**、標準化されたAPIを使ってバックエンドと通信したいので、一貫性のあるエンドポイントとレスポンス形式が欲しい。
2. **モバイルアプリ開発者として**、バッテリー消費を最小限に抑えたいので、効率的なAPIコールとデータ転送が必要。
3. **ユーザーとして**、アプリをスムーズに操作したいので、高速なAPI応答とオフライン対応機能が欲しい。

### 要件

#### 1. RESTful APIエンドポイント

- **1.1** ユーザー管理API
  - ユーザープロフィール取得/更新
  - ギバースコア取得
  - 活動履歴取得
- **1.2** 教材管理API
  - 教材一覧取得（フィルタリング・ソート・ページネーション対応）
  - 教材詳細取得
  - 教材作成/更新/削除
  - 教材評価・レビュー管理
- **1.3** 学習進捗API
  - 進捗状況取得
  - 進捗更新
  - 学習履歴取得
- **1.4** ポイント管理API
  - ポイント残高取得
  - ポイント履歴取得
  - ポイント取引作成

#### 2. API認証・認可

- **2.1** JWTベースの認証
  - APIリクエストヘッダーにトークン要求
  - トークンの検証と権限確認
  - 無効トークンの適切なエラーレスポンス
- **2.2** ロールベースのアクセス制御
  - リソースごとの権限チェック
  - リクエスト元IPアドレスの検証（オプション）
  - レート制限の実装

#### 3. API仕様とドキュメント

- **3.1** OpenAPI（Swagger）仕様の提供
  - 全エンドポイントの詳細ドキュメント
  - リクエスト/レスポンスのスキーマ定義
  - エラーコードと説明
- **3.2** APIバージョニング
  - URLパスによるバージョン管理（例：/api/v1/）
  - 下位互換性の維持ポリシー
  - 非推奨APIの移行ガイド

#### 4. パフォーマンスと最適化

- **4.1** レスポンス圧縮
  - gzip/deflate圧縮の適用
  - 大きなペイロードの適切な分割
- **4.2** キャッシュ対策
  - ETags実装
  - キャッシュヘッダー設定
  - 条件付きリクエスト対応
- **4.3** バッチ処理
  - 複数リソースの一括取得
  - 一括更新機能

### データモデル

```typescript
// APIレスポンスの基本構造
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    pagination?: {
      currentPage: number;
      totalPages: number;
      totalItems: number;
      itemsPerPage: number;
    }
  };
}

// ページネーションリクエストパラメータ
interface PaginationParams {
  page?: number;        // デフォルト: 1
  limit?: number;       // デフォルト: 20, 最大: 100
  sortBy?: string;      // ソートフィールド
  sortOrder?: 'asc' | 'desc'; // ソート順序
}

// フィルタリングパラメータ（教材検索例）
interface MaterialFilterParams extends PaginationParams {
  category?: string;
  difficulty?: 'beginner' | 'intermediate' | 'advanced';
  tags?: string[];
  query?: string;
  creatorId?: string;
  isPremium?: boolean;
}
```

### UIワイヤーフレーム

該当なし（APIはバックエンド機能）

### 振る舞い

#### APIリクエスト・レスポンスフロー

1. クライアントがAPIリクエスト発行（認証トークン付き）
2. APIゲートウェイがリクエストを受信
3. トークン検証と権限チェック
4. 適切なサービスにリクエスト転送
5. ビジネスロジック実行
6. レスポンス生成と形式整形
7. クライアントへレスポンス返却

#### エラー処理フロー

1. エラー発生（リクエスト不正、権限不足、内部エラーなど）
2. エラーコード・メッセージの決定
3. 一貫性のあるエラーレスポンス形式での返却
4. クライアントでのエラーハンドリング

### 例外処理

- **認証エラー**：401 Unauthorized レスポンス
- **権限不足**：403 Forbidden レスポンス
- **リソース未発見**：404 Not Found レスポンス
- **バリデーションエラー**：400 Bad Request + 詳細なエラー情報
- **レート制限超過**：429 Too Many Requests + 制限情報
- **サーバーエラー**：500 Internal Server Error + ログID（デバッグ用）

### テスト条件

#### 単体テスト

- 各エンドポイントの正常・異常パターン
- 認証・認可ロジック
- バリデーションルール
- エラーハンドリング

#### 結合テスト

- エンドツーエンドのAPIフロー
- 実際のデータベースとの連携
- キャッシュ動作確認

#### 負荷テスト

- 高負荷時のレスポンス時間
- 同時接続処理能力
- 長時間安定稼働

## データベース設計

### 概要

データベース設計は、ShiftWithアプリケーションのデータ永続化層を定義します。ユーザー情報、教材コンテンツ、学習進捗、ポイント取引など、アプリケーションの中核データを効率的に格納・取得するための構造を提供します。この設計はSupabaseのPostgreSQLデータベースを基盤として実装されます。

### ユーザーストーリー

1. **システム管理者として**、データの整合性を保ちたいので、適切な関連付けと制約を持つデータベース構造が必要。
2. **バックエンド開発者として**、効率的なクエリを書きたいので、最適化されたテーブル設計とインデックスが欲しい。
3. **データアナリストとして**、ユーザー行動を分析したいので、意味のあるデータ構造とアクセスしやすい統計情報が必要。

### 要件

#### 1. データベースアーキテクチャ

- **1.1** PostgreSQL 13以上の利用
- **1.2** Supabaseプラットフォームとの連携
- **1.3** 論理的なスキーマ分割
  - `public` - 主要アプリケーションデータ
  - `auth` - Supabase認証データ（自動管理）
  - `storage` - ファイルストレージメタデータ
- **1.4** 適切なテーブル命名規則
  - スネークケースの使用
  - 複数形テーブル名（users, materials等）

#### 2. テーブル構造

- **2.1** コアエンティティテーブル
  - ユーザープロフィール
  - 教材
  - ギバー診断結果
  - ポイント履歴
- **2.2** 関連テーブル
  - 学習進捗
  - 教材評価
  - ユーザーロール
  - 活動ログ
- **2.3** 接続テーブル（多対多関係用）
  - ユーザータグ関連
  - 教材タグ関連

#### 3. データセキュリティ

- **3.1** Row Level Security (RLS)ポリシーの実装
  - テーブルごとのアクセス制御
  - ユーザー権限に基づく読み書き制限
- **3.2** データ暗号化
  - 機密情報のカラムレベル暗号化
  - 転送中データの暗号化
- **3.3** バックアップ戦略
  - 日次完全バックアップ
  - ポイントインタイムリカバリ（PITR）設定

#### 4. パフォーマンス最適化

- **4.1** インデックス戦略
  - 主キーと外部キーの自動インデックス
  - 頻繁に検索されるフィールドへの追加インデックス
  - 複合インデックスの適切な設定
- **4.2** クエリ最適化
  - 効率的なJOIN設計
  - マテリアライズドビューの活用
  - クエリプランの分析と改善

### データモデル

以下は主要テーブルのERD概要です：

```
┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐
│  users            │       │  materials        │       │  learning_progress │
├───────────────────┤       ├───────────────────┤       ├───────────────────┤
│ id (PK)           │       │ id (PK)           │       │ id (PK)           │
│ email             │──┐    │ title             │       │ user_id (FK)       │────┐
│ created_at        │  │    │ description       │    ┌──│ material_id (FK)   │    │
│ updated_at        │  │    │ content           │    │  │ progress_percentage│    │
└───────────────────┘  │    │ category          │    │  └───────────────────┘    │
                       │    │ difficulty_level  │    │  ┌───────────────────┐    │
┌───────────────────┐  │    │ user_id (FK)      │────┘                           │
│ user_profiles     │  │    │ created_at        │                                │
├───────────────────┤  │    │ is_premium        │                                │
│ user_id (PK/FK)   │──┘    └───────────────────┘                                │
│ display_name      │                                                            │
│ avatar_url        │       ┌───────────────────┐                                │
│ bio               │       │ points_history    │                                │
│ is_onboarded      │       ├───────────────────┤                                │
└───────────────────┘       │ id (PK)           │                                │
                            │ user_id (FK)      │────────────────────────────────┘
┌───────────────────┐       │ points_amount     │
│ giver_diagnoses   │       │ transaction_type  │
├───────────────────┤       │ source_type       │
│ id (PK)           │       │ created_at        │
│ user_id (FK)      │────┐  └───────────────────┘
│ total_score       │    │
│ primary_type      │    │  ┌───────────────────┐
└───────────────────┘    │  │ material_sections │
                         │  ├───────────────────┤
┌───────────────────┐    │  │ id (PK)           │
│ user_roles        │    │  │ material_id (FK)  │
├───────────────────┤    │  │ title             │
│ id (PK)           │    │  │ content           │
│ user_id (FK)      │────┘  │ sort_order        │
│ role              │       └───────────────────┘
└───────────────────┘
```

### 振る舞い

#### データアクセスパターン

1. ユーザー認証・認可
   - JWT検証後のユーザーID取得
   - RLSポリシーによるアクセス制御適用
   - ユーザーロールに基づく権限チェック

2. 教材関連操作
   - カテゴリ・タグに基づく効率的な検索
   - ユーザー固有の進捗情報の結合
   - 関連教材の推奨アルゴリズム適用

3. ポイント取引管理
   - トランザクション整合性の確保
   - 残高計算の最適化（マテリアライズドビュー活用）
   - 履歴検索と集計の効率化

### 例外処理

- **整合性制約違反**：適切なエラーメッセージと回復アクション
- **同時実行制御**：楽観的ロックと再試行メカニズム
- **クエリタイムアウト**：長時間実行クエリの検出と最適化
- **ストレージ制限到達**：自動スケーリングまたはクリーンアップ
- **接続プール枯渇**：適切な接続管理とモニタリング

### テスト条件

#### データ整合性テスト

- 外部キー制約の検証
- 一意性制約のテスト
- NULL制約とデフォルト値のテスト

#### パフォーマンステスト

- インデックス効率の検証
- 高負荷時のクエリパフォーマンス
- 同時接続処理能力

#### データ移行テスト

- スキーマアップグレードの安全性
- バックアップと復元のテスト
- データ整合性の維持確認