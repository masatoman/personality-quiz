# コロケーション方式テスト構造への移行計画

## 概要

現在のShiftWithプロジェクトでは、テストファイルが別ディレクトリ (`__tests__` フォルダなど) に配置されています。コロケーション方式では、テストファイルがテスト対象と同じディレクトリに配置され、より密接な関連性が明確になります。

## 移行の利点

1. **ファイル関連性の透明化**:
   - テストファイルとソースファイルが同じ場所にあることで、関連性が明確になる
   - テスト対象のコードを修正する際、テストファイルも同時に見つけやすくなる

2. **コード移動時の追跡しやすさ**:
   - コンポーネントやユーティリティを移動する際、テストも一緒に移動できる
   - リファクタリング時の参照エラーを減らせる

3. **テストカバレッジの視認性向上**:
   - どのファイルにテストがあるかが一目でわかる
   - テストがないファイルも明確に識別できる

4. **レビューのしやすさ**:
   - ソースコードとテストコードを同時に確認できる
   - 機能追加時に関連テストの追加も確認しやすい

## 移行ステップ

### 1. テストファイルの命名規則統一

**現状:**
- 複数の命名パターンが混在: `.test.ts`, `.spec.ts`, `Test.tsx` など

**目標:**
```
ComponentName.test.tsx  // コンポーネント用テスト
UtilityName.test.ts     // ユーティリティ用テスト
```

**手順:**
1. テスト種類の命名規則を統一
   - ユニットテスト: `*.test.ts`
   - コンポーネントテスト: `*.test.tsx`
   - 統合テスト: `*.integration.test.tsx`
   - E2Eテスト: `*.e2e.test.ts`

### 2. ディレクトリ構造の変更

**現状:**
```
src/
  components/
    SomeComponent.tsx
  __tests__/
    components/
      SomeComponent.test.tsx
```

**目標:**
```
src/
  components/
    SomeComponent/
      index.tsx
      SomeComponent.test.tsx
```

**手順:**
1. 自動移行スクリプトの作成
2. 段階的なファイル移動
3. インポートパスの更新

### 3. テスト生成スクリプトの更新

既存の `generate-test.ts` スクリプトを更新し、新しいコロケーション構造に対応させる:

```typescript
// 出力先のパス (コロケーション方式)
const OUTPUT_PATHS = {
  component: (name: string) => path.resolve(__dirname, `../../components/${name}/${name}.test.tsx`),
  util: (name: string) => path.resolve(__dirname, `../../utils/${name}/${name}.test.ts`),
  // 他のパスは変更なし
};
```

### 4. 移行スクリプトの実装

以下の自動化スクリプトを実装：

1. テストファイル検索
2. テスト対象ファイルの特定
3. 新しい場所へのファイル移動
4. インポートパスの自動更新
5. エラーチェックと修正

### 5. テスト実行設定の更新

Jest設定を更新して新しいファイル構造に対応：

```javascript
// jest.config.js
testMatch: [
  '**/__tests__/**/*.test.[jt]s?(x)', // 後方互換性のため
  '**/*.test.[jt]s?(x)',              // コロケーション方式用
  '**/*.integration.test.[jt]s?(x)',  // 統合テスト用
]
```

### 6. 段階的移行スケジュール

**Week 1: 準備フェーズ**
- 移行計画の最終化
- スクリプト開発・テスト
- パイロット移行 (小規模コンポーネント)

**Week 2: 本格移行**
- `components` ディレクトリ移行
- `utils` ディレクトリ移行
- パス参照の更新

**Week 3: 後方互換性保証**
- Jest設定の更新
- CI/CD設定の更新
- 移行完了確認

## CIパイプラインとの統合

GitHubワークフローでのテスト実行設定を更新：

```yaml
# .github/workflows/test.yml のテスト実行ステップ
- name: テスト実行
  run: npm run test:coverage
```

## 完了条件

1. すべてのテストファイルが適切な場所に移行されている
2. すべてのインポートパスが更新されている
3. すべてのテストがパスしている
4. CI/CDパイプラインでテストが正常に動作している
5. テストカバレッジレポートが正常に生成される

## リスクと対策

1. **インポートパスエラー**:
   - 対策: 自動修正スクリプトの作成とテスト実行による検証

2. **テスト欠落**:
   - 対策: 移行前後のテスト数の比較確認

3. **CI/CD失敗**:
   - 対策: ステージング環境での事前検証 