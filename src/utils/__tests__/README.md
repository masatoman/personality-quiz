# ShiftWithアプリ ユーティリティ関数テスト

## 概要

このディレクトリには、ShiftWithアプリのコアロジックを実装しているユーティリティ関数のテストが含まれています。特にギバースコア計算、パーソナリティタイプ判定、クイズ結果計算、ポイント管理、バッジ評価などの重要なロジックのテストケースを実装しています。

## テストファイル一覧

- `score.test.ts` - ギバースコア計算ロジックのテスト
- `personality.test.ts` - パーソナリティタイプ判定ロジックのテスト
- `quiz.test.ts` - クイズ結果計算ロジックのテスト
- `badgeEvaluator.test.ts` - バッジ獲得条件評価ロジックのテスト
- `UserActivityTracker.test.ts` - ユーザー行動追跡ロジックのテスト

## テスト実行方法

### 全テスト実行

```bash
npm test src/utils/__tests__
```

### 特定のテスト実行

```bash
npm test src/utils/__tests__/score.test.ts
```

## テストパターン

各ユーティリティ関数のテストでは、以下のパターンをカバーしています：

1. **基本動作のテスト** - 関数の基本的な動作を検証
2. **エッジケースのテスト** - 境界値や特殊なケースでの動作を検証
3. **異常系のテスト** - エラーハンドリングを検証
4. **時間依存のテスト** - 時間経過による変化を検証（例：スコア減衰）

## テスト共通ユーティリティ

テスト用のヘルパー関数や型定義は以下のファイルで提供されています：

- `src/types/test-utils.d.ts` - テスト用型定義
- `src/types/jest.d.ts` - Jestの拡張型定義

## ギバースコア計算の考え方

ShiftWithのコア機能であるギバースコア計算では、以下の要素を考慮してテストを実装しています：

1. **活動タイプによる影響度** - 各活動がギバースコアに与える影響の重みをテスト
2. **時間経過による減衰** - 過去の活動による影響が時間とともに減少する機能をテスト
3. **教材タイプによる重み付け** - 教材タイプによる影響の差異をテスト
4. **スコア集計ロジック** - 複数活動の累積スコア計算をテスト
5. **パーソナリティタイプ判定** - 最終的なパーソナリティタイプ判定をテスト

## モック戦略

テストでは以下のモックアプローチを採用しています：

- 日付/時間のモック - `jest.useFakeTimers()`を使用
- 外部API呼び出しのモック - `jest.spyOn`と`mockResolvedValue`を使用
- ユーザーインタラクションのモック - イベントシミュレーション

## テスト作成方針

新しいユーティリティ関数を追加する場合は、以下の方針でテストを実装してください：

1. 対象の関数が何をするべきかを明確に定義
2. 正常系と異常系の両方のテストケースを作成
3. エッジケースを漏れなく特定してテスト
4. テスト間で状態が漏れないよう注意
5. 各テストの意図がわかりやすい命名を心がける

## 重複テストの問題と解決策

プロジェクト内でテストファイルの重複が発見されたため、以下の整理を行いました：

1. **ユーティリティ関数テストの統合**:
   - `src/utils/__tests__/GiverScoreCalculator.test.ts` と `src/app/__tests__/GiverScoreCalculator.test.ts` を統合
   - 両方の機能を `src/utils/__tests__/GiverScoreCalculator.test.ts` に集約

2. **コンポーネントテストの移動**:
   - `src/utils/__tests__/GiverScoreDisplay.test.tsx` を `src/components/__tests__/GiverScoreDisplay.test.tsx` に統合
   - UIコンポーネントのテストは `components/__tests__` ディレクトリに配置するルールを適用

3. **ポイントシステムテストの統一**:
   - `PointSystem.test.ts` と `PointsSystem.test.ts` の命名不一致を解消
   - `PointsSystem` (末尾に's'あり) に統一

今後、ユーティリティ関数のテストを作成する際は、このディレクトリを使用し、既存テストとの重複がないことを確認してください。コンポーネントのテストは `src/components/__tests__/` ディレクトリに配置し、E2Eテストは `src/app/__tests__/` ディレクトリに配置するようにしてください。

## テストと型定義

テストは型チェックも含めて実行されます。テスト中に型エラーが発生する場合は、以下を確認してください：

1. `src/types/test-utils.d.ts`にJestアサーションメソッドの型定義が追加されているか
2. テストで使用しているモックオブジェクトが正しい型で定義されているか 