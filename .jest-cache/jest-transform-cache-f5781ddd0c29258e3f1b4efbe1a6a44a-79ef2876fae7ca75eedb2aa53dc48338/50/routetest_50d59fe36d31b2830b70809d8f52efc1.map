{"version":3,"sources":["/Users/master/Local Sites/testcursor/src/app/api/rankings/weekly/__tests__/route.test.ts"],"sourcesContent":["import { GET } from '../route';\nimport { pool, initPool } from '@/lib/db';\nimport { NextResponse } from 'next/server';\nimport { unstable_cache } from 'next/cache';\n\n// モックの設定\njest.mock('@/lib/db', () => ({\n  pool: {\n    query: jest.fn(),\n  },\n  initPool: jest.fn(),\n}));\n\njest.mock('next/cache', () => ({\n  unstable_cache: jest.fn((fn) => fn),\n}));\n\ndescribe('週間ランキングAPI', () => {\n  beforeEach(() => {\n    // モックをリセット\n    jest.clearAllMocks();\n  });\n\n  describe('初期化テスト', () => {\n    it('データベース接続の初期化が行われる', async () => {\n      // API呼び出し\n      await GET();\n      \n      // initPoolが呼び出されたことを確認\n      expect(initPool).toHaveBeenCalledTimes(1);\n    });\n  });\n\n  describe('正常系テスト', () => {\n    it('ランキングデータを正しい形式で取得できる', async () => {\n      // モックデータの設定\n      const mockTestResult = { rows: [{ now: new Date() }] };\n      const mockTableCheck = { rows: [{ exists: true }] };\n      const mockIndexCheck = { rows: [{ exists: true }] };\n      const mockRankingResult = {\n        rows: [\n          { user_id: '1', username: 'user1', total_score: 100 },\n          { user_id: '2', username: 'user2', total_score: 90 },\n        ],\n        rowCount: 2,\n      };\n\n      // モックの実装\n      (pool.query as jest.Mock)\n        .mockResolvedValueOnce(mockTestResult)\n        .mockResolvedValueOnce(mockTableCheck)\n        .mockResolvedValueOnce(mockIndexCheck)\n        .mockResolvedValueOnce(mockRankingResult);\n\n      // API呼び出し\n      const response = await GET();\n      const data = await response.json();\n\n      // アサーション\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(data).toEqual({\n        data: [\n          { id: '1', username: 'user1', score: 100, rank: 1 },\n          { id: '2', username: 'user2', score: 90, rank: 2 },\n        ],\n        timestamp: expect.any(String)\n      });\n    });\n\n    it('空のランキングデータを正しく処理できる', async () => {\n      // モックデータの設定\n      const mockTestResult = { rows: [{ now: new Date() }] };\n      const mockTableCheck = { rows: [{ exists: true }] };\n      const mockIndexCheck = { rows: [{ exists: true }] };\n      const mockRankingResult = {\n        rows: [],\n        rowCount: 0,\n      };\n\n      // モックの実装\n      (pool.query as jest.Mock)\n        .mockResolvedValueOnce(mockTestResult)\n        .mockResolvedValueOnce(mockTableCheck)\n        .mockResolvedValueOnce(mockIndexCheck)\n        .mockResolvedValueOnce(mockRankingResult);\n\n      // API呼び出し\n      const response = await GET();\n      const data = await response.json();\n\n      // アサーション\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response.status).toBe(204);\n      expect(data).toEqual({\n        data: [],\n        message: 'ランキングデータが存在しません',\n        timestamp: expect.any(String)\n      });\n    });\n  });\n\n  describe('異常系テスト', () => {\n    it('テーブルが存在しない場合、適切な日本語エラーメッセージを返す', async () => {\n      // モックデータの設定\n      const mockTestResult = { rows: [{ now: new Date() }] };\n      const mockTableCheck = { rows: [{ exists: false }] };\n\n      // モックの実装\n      (pool.query as jest.Mock)\n        .mockResolvedValueOnce(mockTestResult)\n        .mockResolvedValueOnce(mockTableCheck);\n\n      // API呼び出し\n      const response = await GET();\n      const data = await response.json();\n\n      // アサーション\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response.status).toBe(500);\n      expect(data.error).toBe('ランキングの取得に失敗しました');\n      expect(data.details).toBe('quiz_resultsテーブルが存在しません');\n      expect(data.timestamp).toBeDefined();\n    });\n\n    it('データベース接続エラー時、適切な日本語エラーメッセージを返す', async () => {\n      // モックの実装\n      (pool.query as jest.Mock).mockRejectedValue(new Error('データベース接続エラー'));\n\n      // API呼び出し\n      const response = await GET();\n      const data = await response.json();\n\n      // アサーション\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response.status).toBe(500);\n      expect(data.error).toBe('ランキングの取得に失敗しました');\n      expect(data.details).toBe('データベース接続エラー');\n      expect(data.timestamp).toBeDefined();\n    });\n  });\n\n  describe('キャッシュ機能テスト', () => {\n    it('キャッシュが正しく設定される', async () => {\n      // API呼び出し\n      await GET();\n      \n      // キャッシュ設定の確認\n      expect(unstable_cache).toHaveBeenCalledWith(\n        expect.any(Function),\n        ['weekly-rankings'],\n        { revalidate: 300, tags: ['rankings'] }\n      );\n    });\n\n    it('キャッシュ期間内は再クエリが実行されない', async () => {\n      const mockTestResult = { rows: [{ now: new Date() }] };\n      const mockTableCheck = { rows: [{ exists: true }] };\n      const mockIndexCheck = { rows: [{ exists: true }] };\n      const mockRankingResult = {\n        rows: [{ user_id: '1', username: 'user1', total_score: 100 }],\n        rowCount: 1,\n      };\n\n      (pool.query as jest.Mock)\n        .mockResolvedValueOnce(mockTestResult)\n        .mockResolvedValueOnce(mockTableCheck)\n        .mockResolvedValueOnce(mockIndexCheck)\n        .mockResolvedValueOnce(mockRankingResult);\n\n      // 1回目の呼び出し\n      await GET();\n      \n      // 2回目の呼び出し\n      await GET();\n\n      // クエリは1回目の呼び出しでのみ実行される\n      expect(pool.query).toHaveBeenCalledTimes(4);\n    });\n  });\n\n  describe('パフォーマンステスト', () => {\n    it('大量のランキングデータを処理できる', async () => {\n      // 1000件のモックデータを生成\n      const mockRows = Array.from({ length: 1000 }, (_, i) => ({\n        user_id: `${i}`,\n        username: `user${i}`,\n        total_score: 1000 - i,\n      }));\n\n      const mockTestResult = { rows: [{ now: new Date() }] };\n      const mockTableCheck = { rows: [{ exists: true }] };\n      const mockIndexCheck = { rows: [{ exists: true }] };\n      const mockRankingResult = {\n        rows: mockRows,\n        rowCount: 1000,\n      };\n\n      (pool.query as jest.Mock)\n        .mockResolvedValueOnce(mockTestResult)\n        .mockResolvedValueOnce(mockTableCheck)\n        .mockResolvedValueOnce(mockIndexCheck)\n        .mockResolvedValueOnce(mockRankingResult);\n\n      const startTime = Date.now();\n      const response = await GET();\n      const endTime = Date.now();\n      const data = await response.json();\n\n      // 処理時間が1秒未満であることを確認\n      expect(endTime - startTime).toBeLessThan(1000);\n      expect(data.data.length).toBe(1000);\n      expect(data.data[0].rank).toBe(1);\n      expect(data.data[999].rank).toBe(1000);\n    });\n  });\n}); "],"names":["jest","mock","pool","query","fn","initPool","unstable_cache","describe","beforeEach","clearAllMocks","it","GET","expect","toHaveBeenCalledTimes","mockTestResult","rows","now","Date","mockTableCheck","exists","mockIndexCheck","mockRankingResult","user_id","username","total_score","rowCount","mockResolvedValueOnce","response","data","json","toBeInstanceOf","NextResponse","toEqual","id","score","rank","timestamp","any","String","status","toBe","message","error","details","toBeDefined","mockRejectedValue","Error","toHaveBeenCalledWith","Function","revalidate","tags","mockRows","Array","from","length","_","i","startTime","endTime","toBeLessThan"],"mappings":";AAKA,SAAS;AACTA,KAAKC,IAAI,CAAC,YAAY,IAAO,CAAA;QAC3BC,MAAM;YACJC,OAAOH,KAAKI,EAAE;QAChB;QACAC,UAAUL,KAAKI,EAAE;IACnB,CAAA;AAEAJ,KAAKC,IAAI,CAAC,cAAc,IAAO,CAAA;QAC7BK,gBAAgBN,KAAKI,EAAE,CAAC,CAACA,KAAOA;IAClC,CAAA;;;;uBAfoB;oBACW;;uBAEA;;;;;;AAc/BG,SAAS,cAAc;IACrBC,WAAW;QACT,WAAW;QACXR,KAAKS,aAAa;IACpB;IAEAF,SAAS,UAAU;QACjBG,GAAG,qBAAqB;YACtB,UAAU;YACV,MAAMC,IAAAA,UAAG;YAET,uBAAuB;YACvBC,OAAOP,YAAQ,EAAEQ,qBAAqB,CAAC;QACzC;IACF;IAEAN,SAAS,UAAU;QACjBG,GAAG,wBAAwB;YACzB,YAAY;YACZ,MAAMI,iBAAiB;gBAAEC,MAAM;oBAAC;wBAAEC,KAAK,IAAIC;oBAAO;iBAAE;YAAC;YACrD,MAAMC,iBAAiB;gBAAEH,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAMC,iBAAiB;gBAAEL,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAME,oBAAoB;gBACxBN,MAAM;oBACJ;wBAAEO,SAAS;wBAAKC,UAAU;wBAASC,aAAa;oBAAI;oBACpD;wBAAEF,SAAS;wBAAKC,UAAU;wBAASC,aAAa;oBAAG;iBACpD;gBACDC,UAAU;YACZ;YAEA,SAAS;YACRvB,QAAI,CAACC,KAAK,CACRuB,qBAAqB,CAACZ,gBACtBY,qBAAqB,CAACR,gBACtBQ,qBAAqB,CAACN,gBACtBM,qBAAqB,CAACL;YAEzB,UAAU;YACV,MAAMM,WAAW,MAAMhB,IAAAA,UAAG;YAC1B,MAAMiB,OAAO,MAAMD,SAASE,IAAI;YAEhC,SAAS;YACTjB,OAAOe,UAAUG,cAAc,CAACC,qBAAY;YAC5CnB,OAAOgB,MAAMI,OAAO,CAAC;gBACnBJ,MAAM;oBACJ;wBAAEK,IAAI;wBAAKV,UAAU;wBAASW,OAAO;wBAAKC,MAAM;oBAAE;oBAClD;wBAAEF,IAAI;wBAAKV,UAAU;wBAASW,OAAO;wBAAIC,MAAM;oBAAE;iBAClD;gBACDC,WAAWxB,OAAOyB,GAAG,CAACC;YACxB;QACF;QAEA5B,GAAG,uBAAuB;YACxB,YAAY;YACZ,MAAMI,iBAAiB;gBAAEC,MAAM;oBAAC;wBAAEC,KAAK,IAAIC;oBAAO;iBAAE;YAAC;YACrD,MAAMC,iBAAiB;gBAAEH,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAMC,iBAAiB;gBAAEL,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAME,oBAAoB;gBACxBN,MAAM,EAAE;gBACRU,UAAU;YACZ;YAEA,SAAS;YACRvB,QAAI,CAACC,KAAK,CACRuB,qBAAqB,CAACZ,gBACtBY,qBAAqB,CAACR,gBACtBQ,qBAAqB,CAACN,gBACtBM,qBAAqB,CAACL;YAEzB,UAAU;YACV,MAAMM,WAAW,MAAMhB,IAAAA,UAAG;YAC1B,MAAMiB,OAAO,MAAMD,SAASE,IAAI;YAEhC,SAAS;YACTjB,OAAOe,UAAUG,cAAc,CAACC,qBAAY;YAC5CnB,OAAOe,SAASY,MAAM,EAAEC,IAAI,CAAC;YAC7B5B,OAAOgB,MAAMI,OAAO,CAAC;gBACnBJ,MAAM,EAAE;gBACRa,SAAS;gBACTL,WAAWxB,OAAOyB,GAAG,CAACC;YACxB;QACF;IACF;IAEA/B,SAAS,UAAU;QACjBG,GAAG,kCAAkC;YACnC,YAAY;YACZ,MAAMI,iBAAiB;gBAAEC,MAAM;oBAAC;wBAAEC,KAAK,IAAIC;oBAAO;iBAAE;YAAC;YACrD,MAAMC,iBAAiB;gBAAEH,MAAM;oBAAC;wBAAEI,QAAQ;oBAAM;iBAAE;YAAC;YAEnD,SAAS;YACRjB,QAAI,CAACC,KAAK,CACRuB,qBAAqB,CAACZ,gBACtBY,qBAAqB,CAACR;YAEzB,UAAU;YACV,MAAMS,WAAW,MAAMhB,IAAAA,UAAG;YAC1B,MAAMiB,OAAO,MAAMD,SAASE,IAAI;YAEhC,SAAS;YACTjB,OAAOe,UAAUG,cAAc,CAACC,qBAAY;YAC5CnB,OAAOe,SAASY,MAAM,EAAEC,IAAI,CAAC;YAC7B5B,OAAOgB,KAAKc,KAAK,EAAEF,IAAI,CAAC;YACxB5B,OAAOgB,KAAKe,OAAO,EAAEH,IAAI,CAAC;YAC1B5B,OAAOgB,KAAKQ,SAAS,EAAEQ,WAAW;QACpC;QAEAlC,GAAG,kCAAkC;YACnC,SAAS;YACRR,QAAI,CAACC,KAAK,CAAe0C,iBAAiB,CAAC,IAAIC,MAAM;YAEtD,UAAU;YACV,MAAMnB,WAAW,MAAMhB,IAAAA,UAAG;YAC1B,MAAMiB,OAAO,MAAMD,SAASE,IAAI;YAEhC,SAAS;YACTjB,OAAOe,UAAUG,cAAc,CAACC,qBAAY;YAC5CnB,OAAOe,SAASY,MAAM,EAAEC,IAAI,CAAC;YAC7B5B,OAAOgB,KAAKc,KAAK,EAAEF,IAAI,CAAC;YACxB5B,OAAOgB,KAAKe,OAAO,EAAEH,IAAI,CAAC;YAC1B5B,OAAOgB,KAAKQ,SAAS,EAAEQ,WAAW;QACpC;IACF;IAEArC,SAAS,cAAc;QACrBG,GAAG,kBAAkB;YACnB,UAAU;YACV,MAAMC,IAAAA,UAAG;YAET,aAAa;YACbC,OAAON,qBAAc,EAAEyC,oBAAoB,CACzCnC,OAAOyB,GAAG,CAACW,WACX;gBAAC;aAAkB,EACnB;gBAAEC,YAAY;gBAAKC,MAAM;oBAAC;iBAAW;YAAC;QAE1C;QAEAxC,GAAG,wBAAwB;YACzB,MAAMI,iBAAiB;gBAAEC,MAAM;oBAAC;wBAAEC,KAAK,IAAIC;oBAAO;iBAAE;YAAC;YACrD,MAAMC,iBAAiB;gBAAEH,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAMC,iBAAiB;gBAAEL,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAME,oBAAoB;gBACxBN,MAAM;oBAAC;wBAAEO,SAAS;wBAAKC,UAAU;wBAASC,aAAa;oBAAI;iBAAE;gBAC7DC,UAAU;YACZ;YAECvB,QAAI,CAACC,KAAK,CACRuB,qBAAqB,CAACZ,gBACtBY,qBAAqB,CAACR,gBACtBQ,qBAAqB,CAACN,gBACtBM,qBAAqB,CAACL;YAEzB,WAAW;YACX,MAAMV,IAAAA,UAAG;YAET,WAAW;YACX,MAAMA,IAAAA,UAAG;YAET,uBAAuB;YACvBC,OAAOV,QAAI,CAACC,KAAK,EAAEU,qBAAqB,CAAC;QAC3C;IACF;IAEAN,SAAS,cAAc;QACrBG,GAAG,qBAAqB;YACtB,kBAAkB;YAClB,MAAMyC,WAAWC,MAAMC,IAAI,CAAC;gBAAEC,QAAQ;YAAK,GAAG,CAACC,GAAGC,IAAO,CAAA;oBACvDlC,SAAS,CAAC,EAAEkC,EAAE,CAAC;oBACfjC,UAAU,CAAC,IAAI,EAAEiC,EAAE,CAAC;oBACpBhC,aAAa,OAAOgC;gBACtB,CAAA;YAEA,MAAM1C,iBAAiB;gBAAEC,MAAM;oBAAC;wBAAEC,KAAK,IAAIC;oBAAO;iBAAE;YAAC;YACrD,MAAMC,iBAAiB;gBAAEH,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAMC,iBAAiB;gBAAEL,MAAM;oBAAC;wBAAEI,QAAQ;oBAAK;iBAAE;YAAC;YAClD,MAAME,oBAAoB;gBACxBN,MAAMoC;gBACN1B,UAAU;YACZ;YAECvB,QAAI,CAACC,KAAK,CACRuB,qBAAqB,CAACZ,gBACtBY,qBAAqB,CAACR,gBACtBQ,qBAAqB,CAACN,gBACtBM,qBAAqB,CAACL;YAEzB,MAAMoC,YAAYxC,KAAKD,GAAG;YAC1B,MAAMW,WAAW,MAAMhB,IAAAA,UAAG;YAC1B,MAAM+C,UAAUzC,KAAKD,GAAG;YACxB,MAAMY,OAAO,MAAMD,SAASE,IAAI;YAEhC,oBAAoB;YACpBjB,OAAO8C,UAAUD,WAAWE,YAAY,CAAC;YACzC/C,OAAOgB,KAAKA,IAAI,CAAC0B,MAAM,EAAEd,IAAI,CAAC;YAC9B5B,OAAOgB,KAAKA,IAAI,CAAC,EAAE,CAACO,IAAI,EAAEK,IAAI,CAAC;YAC/B5B,OAAOgB,KAAKA,IAAI,CAAC,IAAI,CAACO,IAAI,EAAEK,IAAI,CAAC;QACnC;IACF;AACF"}