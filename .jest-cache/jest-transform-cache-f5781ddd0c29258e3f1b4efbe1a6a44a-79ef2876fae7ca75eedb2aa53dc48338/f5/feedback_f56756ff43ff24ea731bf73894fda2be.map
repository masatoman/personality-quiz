{"version":3,"sources":["/Users/master/Local Sites/testcursor/src/utils/feedback.ts"],"sourcesContent":["import supabase from '@/lib/supabase';\n\n/**\n * フィードバックデータ型定義\n */\nexport interface FeedbackData {\n  materialId: string;\n  userId: string;\n  rating: number;\n  comment: string;\n}\n\n/**\n * フィードバック統計情報型定義\n */\nexport interface FeedbackStatistics {\n  averageRating: number;\n  totalCount: number;\n  ratingDistribution: { rating: number; count: number; percentage: number }[];\n}\n\n/**\n * レスポンス型定義\n */\nexport type ApiResponse<T> = {\n  success: boolean;\n  data?: T;\n  error?: string;\n};\n\n/**\n * フィードバック関連の機能を提供するサービスクラス\n */\nexport class FeedbackService {\n  /**\n   * フィードバックを投稿する\n   * @param data フィードバックデータ\n   * @returns 投稿結果\n   */\n  static async submitFeedback(data: FeedbackData): Promise<ApiResponse<any>> {\n    try {\n      const { materialId, userId, rating, comment } = data;\n      \n      const { data: feedbackData, error } = await supabase\n        .from('feedback')\n        .insert({\n          materialId,\n          userId,\n          rating,\n          comment,\n          createdAt: new Date().toISOString()\n        });\n      \n      if (error) throw error;\n      \n      return {\n        success: true,\n        data: feedbackData\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n  \n  /**\n   * 教材に対するフィードバック一覧を取得する\n   * @param materialId 教材ID\n   * @param limit 取得件数（デフォルト：10件）\n   * @returns フィードバック一覧\n   */\n  static async getFeedbackForMaterial(materialId: string, limit: number = 10): Promise<ApiResponse<any[]>> {\n    try {\n      const { data, error } = await supabase\n        .from('feedback')\n        .select(`\n          id,\n          materialId,\n          userId,\n          users:userId (\n            username:name\n          ),\n          rating,\n          comment,\n          createdAt\n        `)\n        .eq('materialId', materialId)\n        .order('createdAt', { ascending: false })\n        .limit(limit);\n      \n      if (error) throw error;\n      \n      // ユーザー名を含むデータに整形\n      const formattedData = data.map(item => ({\n        ...item,\n        userName: item.users ? item.users.username : '匿名ユーザー',\n        users: undefined // ネストされたデータを削除\n      }));\n      \n      return {\n        success: true,\n        data: formattedData\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n  \n  /**\n   * ユーザーが提供したフィードバック一覧を取得する\n   * @param userId ユーザーID\n   * @param limit 取得件数（デフォルト：10件）\n   * @returns フィードバック一覧\n   */\n  static async getUserFeedback(userId: string, limit: number = 10): Promise<ApiResponse<any[]>> {\n    try {\n      const { data, error } = await supabase\n        .from('feedback')\n        .select(`\n          id,\n          materialId,\n          materials:materialId (\n            title\n          ),\n          userId,\n          rating,\n          comment,\n          createdAt\n        `)\n        .eq('userId', userId)\n        .order('createdAt', { ascending: false })\n        .limit(limit);\n      \n      if (error) throw error;\n      \n      // 教材タイトルを含むデータに整形\n      const formattedData = data.map(item => ({\n        ...item,\n        materialTitle: item.materials ? item.materials.title : '削除された教材',\n        materials: undefined // ネストされたデータを削除\n      }));\n      \n      return {\n        success: true,\n        data: formattedData\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n  \n  /**\n   * 教材のフィードバック統計を取得する\n   * @param materialId 教材ID\n   * @returns フィードバック統計情報\n   */\n  static async getFeedbackStatistics(materialId: string): Promise<ApiResponse<FeedbackStatistics>> {\n    try {\n      // 教材に対する全レーティングを取得\n      const { data, error } = await supabase\n        .from('feedback')\n        .select('rating')\n        .eq('materialId', materialId);\n      \n      if (error) throw error;\n      \n      // 統計情報の計算\n      const totalCount = data.length;\n      \n      if (totalCount === 0) {\n        return {\n          success: true,\n          data: {\n            averageRating: 0,\n            totalCount: 0,\n            ratingDistribution: [\n              { rating: 5, count: 0, percentage: 0 },\n              { rating: 4, count: 0, percentage: 0 },\n              { rating: 3, count: 0, percentage: 0 },\n              { rating: 2, count: 0, percentage: 0 },\n              { rating: 1, count: 0, percentage: 0 }\n            ]\n          }\n        };\n      }\n      \n      // 平均評価を計算\n      const sum = data.reduce((acc, item) => acc + item.rating, 0);\n      const averageRating = Math.round((sum / totalCount) * 10) / 10; // 小数点第1位まで\n      \n      // 評価ごとの分布を計算\n      const distribution = [5, 4, 3, 2, 1].map(rating => {\n        const count = data.filter(item => item.rating === rating).length;\n        const percentage = Math.round((count / totalCount) * 100);\n        return { rating, count, percentage };\n      });\n      \n      return {\n        success: true,\n        data: {\n          averageRating,\n          totalCount,\n          ratingDistribution: distribution\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n} "],"names":["FeedbackService","submitFeedback","data","materialId","userId","rating","comment","feedbackData","error","supabase","from","insert","createdAt","Date","toISOString","success","message","getFeedbackForMaterial","limit","select","eq","order","ascending","formattedData","map","item","userName","users","username","undefined","getUserFeedback","materialTitle","materials","title","getFeedbackStatistics","totalCount","length","averageRating","ratingDistribution","count","percentage","sum","reduce","acc","Math","round","distribution","filter"],"mappings":"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"}