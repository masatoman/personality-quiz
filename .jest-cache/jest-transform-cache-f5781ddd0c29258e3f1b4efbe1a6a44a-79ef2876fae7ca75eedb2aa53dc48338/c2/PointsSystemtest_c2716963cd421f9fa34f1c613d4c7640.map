{"version":3,"sources":["/Users/master/Local Sites/testcursor/backup/src/app/__tests__/PointsSystem.test.ts"],"sourcesContent":["import { consumePoints, fetchPointsBalance, PURCHASABLE_ITEMS } from '../../utils/points';\n\n// APIをモック\nglobal.fetch = jest.fn();\n\ndescribe('ポイントシステム', () => {\n  beforeEach(() => {\n    jest.resetAllMocks();\n  });\n  \n  describe('ポイント消費関数', () => {\n    it('ポイント消費に成功した場合、成功レスポンスを返す', async () => {\n      // モックレスポンスを設定\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        json: async () => ({\n          success: true,\n          consumedPoints: 100,\n          remainingPoints: 400\n        })\n      });\n      \n      // ポイント消費関数を実行\n      const result = await consumePoints(100, 'purchase_item', {\n        referenceId: 'item_1',\n        referenceType: 'item',\n        description: 'アイテム購入'\n      });\n      \n      // 正しいエンドポイントとパラメータでAPIが呼び出されているか検証\n      expect(global.fetch).toHaveBeenCalledWith('/api/points/consume', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          points: 100,\n          actionType: 'purchase_item',\n          referenceId: 'item_1',\n          referenceType: 'item',\n          description: 'アイテム購入'\n        }),\n      });\n      \n      // 成功レスポンスが返されるか検証\n      expect(result).toEqual({\n        success: true,\n        consumedPoints: 100,\n        remainingPoints: 400\n      });\n    });\n    \n    it('ポイント不足の場合、エラーレスポンスを返す', async () => {\n      // モックレスポンスを設定\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        json: async () => ({\n          error: 'ポイントが不足しています',\n          currentPoints: 50,\n          requiredPoints: 100\n        })\n      });\n      \n      // ポイント消費関数を実行\n      const result = await consumePoints(100, 'purchase_item');\n      \n      // エラーレスポンスが返されるか検証\n      expect(result).toEqual({\n        success: false,\n        error: 'ポイントが不足しています',\n        currentPoints: 50,\n        requiredPoints: 100\n      });\n    });\n    \n    it('通信エラーの場合、エラーレスポンスを返す', async () => {\n      // フェッチ関数がエラーをスローする場合\n      (global.fetch as jest.Mock).mockRejectedValueOnce(new Error('Network error'));\n      \n      // ポイント消費関数を実行\n      const result = await consumePoints(100, 'purchase_item');\n      \n      // エラーレスポンスが返されるか検証\n      expect(result).toEqual({\n        success: false,\n        error: '通信エラーが発生しました'\n      });\n    });\n  });\n  \n  describe('ポイント残高取得関数', () => {\n    it('ポイント残高取得に成功した場合、成功レスポンスを返す', async () => {\n      // モックレスポンスを設定\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        json: async () => ({\n          points: 500\n        })\n      });\n      \n      // ポイント残高取得関数を実行\n      const result = await fetchPointsBalance();\n      \n      // 正しいエンドポイントでAPIが呼び出されているか検証\n      expect(global.fetch).toHaveBeenCalledWith('/api/points/balance');\n      \n      // 成功レスポンスが返されるか検証\n      expect(result).toEqual({\n        success: true,\n        points: 500\n      });\n    });\n    \n    it('認証エラーの場合、エラーレスポンスを返す', async () => {\n      // モックレスポンスを設定\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        json: async () => ({\n          error: '認証が必要です'\n        })\n      });\n      \n      // ポイント残高取得関数を実行\n      const result = await fetchPointsBalance();\n      \n      // エラーレスポンスが返されるか検証\n      expect(result).toEqual({\n        success: false,\n        error: '認証が必要です'\n      });\n    });\n  });\n  \n  describe('購入可能アイテム', () => {\n    it('購入可能アイテムのリストが正しく定義されている', () => {\n      // 購入可能アイテムリストが配列として存在するか検証\n      expect(Array.isArray(PURCHASABLE_ITEMS)).toBe(true);\n      \n      // 少なくとも1つのアイテムが存在するか検証\n      expect(PURCHASABLE_ITEMS.length).toBeGreaterThan(0);\n      \n      // 各アイテムが必要なプロパティを持っているか検証\n      PURCHASABLE_ITEMS.forEach(item => {\n        expect(item).toHaveProperty('id');\n        expect(item).toHaveProperty('name');\n        expect(item).toHaveProperty('description');\n        expect(item).toHaveProperty('points');\n        expect(item).toHaveProperty('category');\n        \n        // ポイントは数値であるか検証\n        expect(typeof item.points).toBe('number');\n        expect(item.points).toBeGreaterThan(0);\n      });\n    });\n  });\n}); "],"names":["global","fetch","jest","fn","describe","beforeEach","resetAllMocks","it","mockResolvedValueOnce","ok","json","success","consumedPoints","remainingPoints","result","consumePoints","referenceId","referenceType","description","expect","toHaveBeenCalledWith","method","headers","body","JSON","stringify","points","actionType","toEqual","error","currentPoints","requiredPoints","mockRejectedValueOnce","Error","fetchPointsBalance","Array","isArray","PURCHASABLE_ITEMS","toBe","length","toBeGreaterThan","forEach","item","toHaveProperty"],"mappings":"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"}